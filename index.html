<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Powerplugs Daily Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0a0f; color: #e0e0e0; min-height: 100vh; }
  .header { background: linear-gradient(135deg, #12121a 0%, #1a1a2e 100%); border-bottom: 1px solid #2a2a3e; padding: 20px 40px; display: flex; align-items: center; justify-content: space-between; }
  .header h1 { font-size: 22px; font-weight: 700; color: #fff; }
  .header h1 span { color: #7c5cfc; }
  .header-meta { font-size: 13px; color: #888; }
  .filter-bar { display: flex; align-items: center; gap: 16px; padding: 16px 40px; background: #111118; border-bottom: 1px solid #1e1e30; flex-wrap: wrap; }
  .filter-group { display: flex; align-items: center; gap: 8px; }
  .filter-group label { font-size: 12px; text-transform: uppercase; letter-spacing: 0.8px; color: #666; white-space: nowrap; }
  .filter-bar select { background: #1a1a2e; border: 1px solid #2a2a3e; color: #e0e0e0; padding: 8px 14px; border-radius: 8px; font-size: 13px; cursor: pointer; outline: none; }
  .filter-bar select:hover { border-color: #7c5cfc; }
  .filter-bar select:focus { border-color: #7c5cfc; box-shadow: 0 0 0 2px rgba(124,92,252,0.15); }

  /* Tabs */
  .tab-bar { display: flex; gap: 0; padding: 0 40px; background: #0e0e16; border-bottom: 1px solid #1e1e30; }
  .tab-btn { padding: 12px 24px; font-size: 14px; font-weight: 600; color: #666; cursor: pointer; border: none; background: transparent; border-bottom: 3px solid transparent; transition: all 0.2s; }
  .tab-btn:hover { color: #aaa; }
  .tab-btn.active { color: #7c5cfc; border-bottom-color: #7c5cfc; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* Dashboard tab */
  .kpi-strip { display: grid; grid-template-columns: repeat(5, 1fr); gap: 14px; padding: 20px 40px; }
  .kpi-card { background: linear-gradient(135deg, #16162a 0%, #1c1c32 100%); border: 1px solid #2a2a3e; border-radius: 12px; padding: 18px; }
  .kpi-card .label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.8px; color: #888; margin-bottom: 6px; }
  .kpi-card .value { font-size: 24px; font-weight: 700; color: #fff; }
  .dashboard { padding: 0 40px 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
  .chart-card { background: linear-gradient(135deg, #16162a 0%, #1c1c32 100%); border: 1px solid #2a2a3e; border-radius: 12px; padding: 22px; }
  .chart-card.full-width { grid-column: 1 / -1; }
  .chart-card h2 { font-size: 15px; font-weight: 600; color: #fff; margin-bottom: 3px; }
  .chart-card .subtitle { font-size: 11px; color: #555; margin-bottom: 16px; }
  .chart-container { position: relative; width: 100%; height: 320px; }
  .chart-card.full-width .chart-container { height: 360px; }
  .chart-legend { display: flex; gap: 16px; margin-bottom: 12px; flex-wrap: wrap; }
  .chart-legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; color: #aaa; }
  .chart-legend-item .line-sample { width: 28px; height: 3px; border-radius: 2px; }
  .chart-legend-item .line-dotted { width: 28px; height: 0; border-top: 3px dotted; }
  .chart-legend-item .line-dashed { width: 28px; height: 0; border-top: 3px dashed; }
  .projection-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  .projection-table th { text-align: left; font-size: 10px; text-transform: uppercase; letter-spacing: 0.8px; color: #555; padding: 8px 10px; border-bottom: 1px solid #2a2a3e; }
  .projection-table td { padding: 9px 10px; font-size: 13px; border-bottom: 1px solid #1a1a2e; }
  .projection-table tr:hover td { background: rgba(124,92,252,0.04); }
  .plug-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
  .badge-AFib { background: rgba(239,68,68,0.15); color: #ef4444; }
  .badge-Cardio { background: rgba(59,130,246,0.15); color: #3b82f6; }
  .badge-CnO { background: rgba(168,85,247,0.15); color: #a855f7; }
  .badge-CnOPlus { background: rgba(192,132,252,0.15); color: #c084fc; }
  .badge-Respiratory { background: rgba(34,197,94,0.15); color: #22c55e; }
  .badge-Tesla { background: rgba(234,179,8,0.15); color: #eab308; }
  .badge-General { background: rgba(124,92,252,0.15); color: #7c5cfc; }
  .projected { color: #7c5cfc; font-weight: 600; }
  .target-col { color: #f59e0b; font-weight: 600; }
  .btn { padding: 7px 16px; border-radius: 8px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s; }
  .btn-primary { background: #7c5cfc; color: #fff; }
  .btn-primary:hover { background: #6a4be6; }
  .btn-secondary { background: rgba(124,92,252,0.12); color: #7c5cfc; border: 1px solid rgba(124,92,252,0.3); }
  .btn-secondary:hover { background: rgba(124,92,252,0.2); }
  .btn-danger { background: rgba(239,68,68,0.15); color: #ef4444; border: 1px solid rgba(239,68,68,0.3); padding: 4px 10px; font-size: 12px; }
  .btn-danger:hover { background: rgba(239,68,68,0.25); }
  .campaign-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
  .campaign-table { width: 100%; border-collapse: collapse; }
  .campaign-table th { text-align: left; font-size: 10px; text-transform: uppercase; letter-spacing: 0.8px; color: #555; padding: 8px 6px; border-bottom: 1px solid #2a2a3e; }
  .campaign-table td { padding: 6px 6px; border-bottom: 1px solid #1a1a2e; vertical-align: middle; }
  .campaign-table input, .campaign-table select { background: #12121e; border: 1px solid #2a2a3e; color: #e0e0e0; padding: 5px 8px; border-radius: 6px; font-size: 12px; width: 100%; outline: none; }
  .campaign-table input:focus, .campaign-table select:focus { border-color: #7c5cfc; }
  .campaign-table input[type="number"] { width: 100px; }
  .campaign-table input[type="date"] { width: 130px; }
  .campaign-table select { min-width: 90px; }
  .progress-bar-container { display: flex; align-items: center; gap: 12px; margin-top: 14px; padding: 14px; background: #12121e; border-radius: 10px; border: 1px solid #1e1e30; }
  .progress-bar-track { flex: 1; height: 10px; background: #1e1e30; border-radius: 5px; overflow: hidden; }
  .progress-bar-fill { height: 100%; border-radius: 5px; transition: width 0.5s ease; }
  .progress-bar-fill.good { background: linear-gradient(90deg, #22c55e, #4ade80); }
  .progress-bar-fill.warn { background: linear-gradient(90deg, #eab308, #facc15); }
  .progress-bar-fill.bad { background: linear-gradient(90deg, #ef4444, #f87171); }
  .progress-text { font-size: 13px; color: #aaa; white-space: nowrap; min-width: 180px; }
  .progress-text strong { color: #fff; }
  .no-campaigns { text-align: center; padding: 40px; color: #555; font-size: 14px; }

  /* Insights */
  .insights-section { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  .insight-card { background: #12121e; border: 1px solid #1e1e30; border-radius: 10px; padding: 16px; }
  .insight-card h3 { font-size: 13px; font-weight: 600; color: #7c5cfc; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
  .insight-item { font-size: 13px; color: #bbb; padding: 4px 0; line-height: 1.5; }
  .insight-item .up { color: #22c55e; font-weight: 600; }
  .insight-item .down { color: #ef4444; font-weight: 600; }
  .insight-item .neutral { color: #eab308; font-weight: 600; }
  .insight-item .val { color: #fff; font-weight: 600; }
  .pp-legend { display: flex; gap: 16px; flex-wrap: wrap; margin-top: 8px; padding: 10px 0; }
  .pp-legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; color: #aaa; }
  .pp-legend-dot { width: 10px; height: 10px; border-radius: 50%; }

  /* User Stats */
  .user-stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 14px; }
  .user-stat-card { background: #12121e; border: 1px solid #1e1e30; border-radius: 10px; padding: 16px; text-align: center; }
  .user-stat-card .stat-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.6px; color: #666; margin-bottom: 6px; }
  .user-stat-card .stat-value { font-size: 28px; font-weight: 700; color: #fff; }
  .user-stat-card .stat-sub { font-size: 12px; color: #888; margin-top: 4px; }
  .gender-bar { display: flex; height: 8px; border-radius: 4px; overflow: hidden; margin-top: 8px; }
  .gender-bar .male { background: #3b82f6; }
  .gender-bar .female { background: #ec4899; }
  .gender-labels { display: flex; justify-content: space-between; margin-top: 4px; font-size: 11px; }
  .gender-labels .m { color: #3b82f6; }
  .gender-labels .f { color: #ec4899; }

  /* Disclaimers */
  .disclaimers { padding: 14px 40px 24px; }
  .disclaimer-item { font-size: 12px; color: #666; padding: 4px 0; }
  .disclaimer-item::before { content: '*'; color: #7c5cfc; margin-right: 6px; }

  /* Active Countries tab */
  .countries-section { padding: 24px 40px 40px; }
  .countries-section h2 { font-size: 18px; font-weight: 700; color: #fff; margin-bottom: 6px; }
  .countries-section .subtitle { font-size: 12px; color: #666; margin-bottom: 20px; }
  .country-table { width: 100%; border-collapse: collapse; background: linear-gradient(135deg, #16162a 0%, #1c1c32 100%); border: 1px solid #2a2a3e; border-radius: 12px; overflow: hidden; }
  .country-table th { text-align: center; font-size: 11px; text-transform: uppercase; letter-spacing: 0.6px; color: #888; padding: 12px 14px; border-bottom: 1px solid #2a2a3e; }
  .country-table th:first-child { text-align: left; }
  .country-table td { padding: 10px 14px; text-align: center; border-bottom: 1px solid #1a1a2e; font-size: 13px; }
  .country-table td:first-child { text-align: left; font-weight: 600; color: #ccc; }
  .country-table tr:hover td { background: rgba(124,92,252,0.04); }
  .check-cell { cursor: pointer; font-size: 18px; user-select: none; }
  .check-cell.active { color: #22c55e; }
  .check-cell.inactive { color: #333; }

  /* Email Campaigns tab */
  .email-section { padding: 24px 40px 40px; }
  .email-section h2 { font-size: 18px; font-weight: 700; color: #fff; margin-bottom: 6px; }
  .email-section .subtitle { font-size: 12px; color: #666; margin-bottom: 20px; }
  .email-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
  .email-header-actions { display: flex; gap: 10px; align-items: center; }
  .email-table { width: 100%; border-collapse: collapse; background: linear-gradient(135deg, #16162a 0%, #1c1c32 100%); border: 1px solid #2a2a3e; border-radius: 12px; overflow: hidden; }
  .email-table th { text-align: left; font-size: 10px; text-transform: uppercase; letter-spacing: 0.6px; color: #555; padding: 10px 8px; border-bottom: 1px solid #2a2a3e; }
  .email-table td { padding: 8px 8px; border-bottom: 1px solid #1a1a2e; vertical-align: middle; }
  .email-table input, .email-table select { background: #12121e; border: 1px solid #2a2a3e; color: #e0e0e0; padding: 5px 8px; border-radius: 6px; font-size: 12px; width: 100%; outline: none; }
  .email-table input:focus, .email-table select:focus { border-color: #7c5cfc; }
  .email-table input[type="number"] { width: 80px; }
  .email-table input[type="date"] { width: 130px; }
  .calculated { color: #7c5cfc; font-weight: 600; font-size: 12px; }
  .csv-upload { display: none; }

  @media (max-width: 1200px) { .kpi-strip { grid-template-columns: repeat(3, 1fr); } .dashboard { grid-template-columns: 1fr; } }
</style>
</head>
<body>
<div class="header">
  <h1><span>Powerplugs</span> Daily Dashboard</h1>
  <div class="header-meta">Last updated: <span id="lastUpdated"></span></div>
</div>
<div class="filter-bar">
  <div class="filter-group">
    <label>Powerplug</label>
    <select id="filterPP">
      <option value="All">All Powerplugs</option>
      <option value="AFib">AFib</option>
      <option value="Cardio">Cardio Adaptability</option>
      <option value="CnO Pro">C&amp;O Pro/Plus</option>
      <option value="Respiratory">Respiratory</option>
      <option value="Tesla">Tesla</option>
    </select>
  </div>
  <div class="filter-group">
    <label>Country</label>
    <select id="filterCountry">
      <option value="All">All Countries</option>
      <option value="US">USA</option>
      <option value="IN">India</option>
      <option value="CA">Canada</option>
      <option value="GB">UK + IR</option>
      <option value="AU">Australia</option>
      <option value="DE">Germany</option>
      <option value="AE">UAE</option>
      <option value="CZ">Czech Republic</option>
      <option value="TH">Thailand</option>
      <option value="CH">Switzerland</option>
      <option value="ES">Spain</option>
      <option value="NL">Netherlands</option>
      <option value="SG">Singapore</option>
      <option value="PH">Philippines</option>
    </select>
  </div>
  <div class="filter-group">
    <label>Month</label>
    <select id="filterMonth"></select>
  </div>
</div>

<!-- Tab Navigation -->
<div class="tab-bar">
  <button class="tab-btn active" onclick="switchTab('dashboard')">Dashboard</button>
  <button class="tab-btn" onclick="switchTab('countries')">Active Countries</button>
  <button class="tab-btn" onclick="switchTab('emails')">Email Campaigns</button>
</div>

<!-- ============ TAB 1: DASHBOARD ============ -->
<div id="tab-dashboard" class="tab-content active">
  <div class="kpi-strip" id="kpiStrip"></div>
  <div class="dashboard">
    <div class="chart-card full-width">
      <h2>Monthly Summary</h2>
      <div class="subtitle">Revenue, users, trial/paid breakdown, purchases &amp; subscriptions with projections</div>
      <div id="projectionTable"></div>
    </div>
    <div class="chart-card full-width">
      <h2>Daily Revenue</h2>
      <div class="subtitle">Solid = Actual | Dotted = Run-rate Projection | Dashed = Monthly Plan Target</div>
      <div class="chart-legend">
        <div class="chart-legend-item"><div class="line-sample" style="background:#7c5cfc;"></div> Actual</div>
        <div class="chart-legend-item"><div class="line-dotted" style="border-color:#7c5cfc;"></div> Projected</div>
        <div class="chart-legend-item"><div class="line-dashed" style="border-color:#f59e0b;"></div> Plan Target</div>
      </div>
      <div class="chart-container"><canvas id="revenueChart"></canvas></div>
      <div class="pp-legend" id="ppLegend"></div>
    </div>
    <div class="chart-card">
      <h2>Trial vs Converted Users</h2>
      <div class="subtitle">Real trial &amp; conversion data from RevCat for all powerplugs</div>
      <div class="chart-container"><canvas id="trialChart"></canvas></div>
    </div>
    <div class="chart-card">
      <h2>Conversion Rate</h2>
      <div class="subtitle">Subscription-to-purchase conversion %</div>
      <div class="chart-container"><canvas id="conversionChart"></canvas></div>
    </div>
    <div class="chart-card full-width">
      <h2>Daily Purchase Volume</h2>
      <div class="subtitle">Number of powerplug purchases per day</div>
      <div class="chart-container"><canvas id="purchaseChart"></canvas></div>
    </div>
    <div class="chart-card full-width">
      <h2>Insights & Trends</h2>
      <div class="subtitle">Auto-generated analysis based on current data and filters</div>
      <div class="insights-section" id="insightsSection"></div>
    </div>
    <div class="chart-card full-width">
      <div class="campaign-header">
        <div><h2>Monthly Plan</h2><div class="subtitle">Track initiatives, expected revenue, status - persists across sessions</div></div>
        <button class="btn btn-primary" onclick="addCampaign()">+ Add Initiative</button>
      </div>
      <div id="campaignProgress"></div>
      <div id="campaignTracker"></div>
    </div>
    <div class="chart-card full-width">
      <h2>User Base</h2>
      <div class="subtitle">Active users per powerplug with gender split. Note: one user may use multiple powerplugs, so total â‰  sum of individual PPs.</div>
      <div class="user-stats-grid" id="userStatsGrid"></div>
    </div>
    <div class="chart-card full-width">
      <h2>Country Revenue Breakdown</h2>
      <div class="subtitle">Select a country from the dropdown above to see its detailed monthly revenue. Shows all countries ranked when set to "All".</div>
      <div id="countryRevenueTable"></div>
    </div>
  </div>
  <div class="disclaimers">
    <div class="disclaimer-item">C&amp;O Pro and C&amp;O Plus are separate products available in different countries. Revenue data is currently combined under C&amp;O Pro/Plus.</div>
    <div class="disclaimer-item">Cardio Adaptability and AFib are the same powerplug &mdash; in some countries one is available and in some the other.</div>
    <div class="disclaimer-item">One user may use multiple powerplugs. Total active users is not a simple sum of per-powerplug counts.</div>
  </div>
</div>

<!-- ============ TAB 2: ACTIVE COUNTRIES ============ -->
<div id="tab-countries" class="tab-content">
  <div class="countries-section">
    <h2>Active Countries by Powerplug</h2>
    <div class="subtitle">Click a cell to toggle availability. Data is saved locally.</div>
    <div id="countryGrid"></div>
  </div>
</div>

<!-- ============ TAB 3: EMAIL CAMPAIGNS ============ -->
<div id="tab-emails" class="tab-content">
  <div class="email-section">
    <div class="email-header">
      <div>
        <h2>Email Campaigns</h2>
        <div class="subtitle">Track HubSpot powerplug email campaigns and engagement metrics</div>
      </div>
      <div class="email-header-actions">
        <input type="file" id="csvUpload" class="csv-upload" accept=".csv" onchange="importEmailCSV(this)" />
        <button class="btn btn-secondary" onclick="document.getElementById('csvUpload').click()">Import CSV</button>
        <button class="btn btn-primary" onclick="addEmailCampaign()">+ Add Email Campaign</button>
      </div>
    </div>
    <div id="emailTracker"></div>
  </div>
</div>

<script>
// ============================================================
// REAL DATA FROM METABASE
// ============================================================
const PLUGS = ['AFib', 'Cardio', 'CnO Pro', 'Respiratory', 'Tesla'];
// For Active Countries tab, C&O Pro and C&O Plus are separate columns
const COUNTRY_PLUGS = ['AFib', 'Cardio', 'CnO Pro', 'CnO Plus', 'Respiratory', 'Tesla'];
const DISPLAY_NAMES = { 'CnO Pro': 'C&O Pro', 'CnO Plus': 'C&O Plus', 'Cardio': 'Cardio Adaptability', 'AFib': 'AFib', 'Respiratory': 'Respiratory', 'Tesla': 'Tesla', 'General': 'General' };
function displayName(p) { return DISPLAY_NAMES[p] || p; }
const COLORS = {
  'AFib':        { border: '#ef4444', fill: 'rgba(239,68,68,0.08)' },
  'Cardio':      { border: '#3b82f6', fill: 'rgba(59,130,246,0.08)' },
  'CnO Pro':     { border: '#a855f7', fill: 'rgba(168,85,247,0.08)' },
  'CnO Plus':    { border: '#c084fc', fill: 'rgba(192,132,252,0.08)' },
  'Respiratory': { border: '#22c55e', fill: 'rgba(34,197,94,0.08)' },
  'Tesla':       { border: '#eab308', fill: 'rgba(234,179,8,0.08)' },
  'All':         { border: '#7c5cfc', fill: 'rgba(124,92,252,0.08)' },
};

const COUNTRIES = ['USA','India','Canada','UK + IR','Australia','Germany','UAE','Czech Republic','Thailand','Switzerland','Spain','Netherlands','Singapore','Philippines'];

// ============================================================
// GOOGLE SHEETS CONFIG (injected by refresh_dashboard.py)
// ============================================================
const GOOGLE_SHEETS_ID = '';
const GOOGLE_API_KEY = '';
const GOOGLE_APPS_SCRIPT_URL = '';

// ============================================================
// GOOGLE SHEETS INTEGRATION (dual-layer: Sheets + localStorage)
// ============================================================
const SheetsAPI = {
  enabled: Boolean(GOOGLE_SHEETS_ID && GOOGLE_API_KEY),

  // Read from Google Sheets (public, via API key)
  async read(tabName) {
    if (!this.enabled) return null;
    try {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEETS_ID}/values/${encodeURIComponent(tabName)}?key=${GOOGLE_API_KEY}`;
      const resp = await fetch(url);
      if (!resp.ok) throw new Error(`Sheets API ${resp.status}`);
      const data = await resp.json();
      const rows = data.values || [];
      if (rows.length < 2) return []; // Only headers, no data
      const headers = rows[0];
      return rows.slice(1).map(row => {
        const obj = {};
        headers.forEach((h, i) => obj[h] = row[i] || '');
        return obj;
      });
    } catch (e) {
      console.warn(`Sheets read failed for ${tabName}:`, e.message);
      return null;
    }
  },

  // Write to Google Sheets (via Apps Script web app)
  async write(tabName, data, headers) {
    if (!GOOGLE_APPS_SCRIPT_URL) return false;
    try {
      const resp = await fetch(GOOGLE_APPS_SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' }, // Apps Script needs text/plain for CORS
        body: JSON.stringify({ action: 'write', tab: tabName, data, headers }),
      });
      return resp.ok;
    } catch (e) {
      console.warn(`Sheets write failed for ${tabName}:`, e.message);
      return false;
    }
  }
};

const REVENUE_DATA = {"2025-09":{"dates":["2025-09-01","2025-09-02","2025-09-03","2025-09-04","2025-09-05","2025-09-06","2025-09-07","2025-09-08","2025-09-09","2025-09-10","2025-09-11","2025-09-12","2025-09-13","2025-09-14","2025-09-15","2025-09-16","2025-09-17","2025-09-18","2025-09-19","2025-09-20","2025-09-21","2025-09-22","2025-09-23","2025-09-24","2025-09-25","2025-09-26","2025-09-27","2025-09-28","2025-09-29","2025-09-30"],"revenue":{"AFib":[517.56,445.48,514.25,726.71,287.4,774.46,267.55,349.24,281.49,215.24,585.54,561.48,644.49,426.21,235.03,918.06,592.16,291.06,373.46,287.69,651.22,806.14,868.69,1014.22,500.79,463.57,466.7,965.5,596.76,353.45],"Cardio":[2523.3,2352.73,3213.29,2500.67,2617.67,1956.49,2284.56,2629.94,1794.39,1877.97,1842.63,2287.14,2220.79,1917.88,2247.82,2125.87,1895.56,1601.07,2148.5,1657.71,1312.14,2238.44,1770.78,1593.51,1473.81,1915.31,2083.86,2064.72,1761.08,2021.07],"CnO Pro":[4846.5,5300.16,5206.5,4134.2,3845.52,3358.35,3135.38,3630.64,3868.94,3188.1,3476.25,3428.28,3009.49,2349.93,3167.24,3085.72,2707.07,3541.86,8247.16,5163.19,3884.43,4648.19,4486.3,4203.31,5197.06,5625.91,5272.45,5979.27,5379.01,6829.85],"Respiratory":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],"Tesla":[8.95,75.9,20.95,13.7,18.59,8.96,69.0,83.66,13.8,0,6.9,6.9,82.7,6.9,69.0,20.7,0,6.9,6.8,22.76,6.9,0,13.8,72.14,20.7,0,21.79,0,6.9,49.72]},"subscriptions":{"AFib":[16,20,13,20,10,25,15,13,14,13,18,18,16,16,12,26,21,24,35,24,31,33,40,33,19,18,16,27,21,18],"Cardio":[146,136,164,150,144,125,142,144,140,125,128,139,122,150,135,142,120,124,134,127,107,149,110,106,104,140,119,149,133,151],"CnO Pro":[152,154,172,126,125,116,104,117,103,96,111,112,94,72,98,84,91,297,1381,737,478,365,342,253,262,243,233,247,232,289],"Respiratory":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],"Tesla":[1,2,3,2,2,1,1,3,2,0,1,1,3,1,1,3,0,1,1,3,1,0,2,2,3,0,3,0,1,6]}},"2025-10":{"dates":["2025-10-01","2025-10-02","2025-10-03","2025-10-04","2025-10-05","2025-10-06","2025-10-07","2025-10-08","2025-10-09","2025-10-10","2025-10-11","2025-10-12","2025-10-13","2025-10-14","2025-10-15","2025-10-16","2025-10-17","2025-10-18","2025-10-19","2025-10-20","2025-10-21","2025-10-22","2025-10-23","2025-10-24","2025-10-25","2025-10-26","2025-10-27","2025-10-28","2025-10-29","2025-10-30","2025-10-31"],"revenue":{"AFib":[396.23,348.25,431.53,440.03,329.86,444.11,409.22,195.12,143.54,318.72,387.46,498.75,397.13,412.47,412.48,418.77,180.66,272.39,148.38,305.47,465.75,462.05,166.04,386.99,128.36,276.69,524.62,447.3,430.67,421.02,179.99],"Cardio":[2146.94,1912.29,1980.59,2131.83,1747.71,2060.86,2232.92,2467.92,2736.81,2443.6,2063.19,1730.45,2047.91,1600.74,1387.71,1247.42,1059.58,1087.14,881.42,977.45,675.18,988.55,782.13,1412.29,945.82,1169.21,806.04,940.35,1067.55,1235.34,570.47],"CnO Pro":[5957.28,5963.41,5198.76,5068.48,4828.34,4668.94,6134.59,5474.49,5425.91,5013.84,3890.98,3767.59,4119.78,4464.42,3284.38,3249.26,3383.34,2875.19,7319.25,5597.43,3867.42,3264.29,3047.16,3390.02,2326.5,2864.28,3350.09,2793.03,2669.13,2644.7,2260.91],"Respiratory":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],"Tesla":[15.77,13.7,20.87,6.8,9.2,69.0,0,23.53,6.9,0,6.9,13.8,82.7,0,98.89,20.7,7.91,13.8,6.8,84.83,6.9,0,0,98.89,13.8,0,14.9,0,14.81,103.87,8.08]},"subscriptions":{"AFib":[19,17,15,18,15,19,23,12,13,18,16,18,13,16,15,22,11,19,17,14,26,20,18,17,13,21,14,19,21,14,10],"Cardio":[139,121,127,133,123,130,137,132,159,144,135,113,118,133,109,118,97,108,98,98,84,106,78,102,88,109,75,110,103,100,48],"CnO Pro":[220,214,224,187,186,178,196,204,170,167,171,151,139,147,133,117,146,305,1278,701,490,356,311,273,221,204,212,177,176,188,132],"Respiratory":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],"Tesla":[2,2,3,1,1,1,0,3,1,0,1,2,3,0,2,3,1,2,1,3,1,0,0,2,2,0,2,0,2,5,1]}},"2025-11":{"dates":["2025-11-01","2025-11-02","2025-11-03","2025-11-04","2025-11-05","2025-11-06","2025-11-07","2025-11-08","2025-11-09","2025-11-10","2025-11-11","2025-11-12","2025-11-13","2025-11-14","2025-11-15","2025-11-16","2025-11-17","2025-11-18","2025-11-19","2025-11-20","2025-11-21","2025-11-22","2025-11-23","2025-11-24","2025-11-25","2025-11-26","2025-11-27","2025-11-28","2025-11-29","2025-11-30"],"revenue":{"AFib":[526.89,833.13,294.02,368.28,452.93,1575.83,1097.72,799.79,798.41,859.93,483.2,430.48,428.19,456.02,355.24,403.82,394.4,324.1,518.85,5438.81,4289.66,2846.74,2261.63,1910.0,1349.4,2463.22,2440.72,3433.2,2253.84,2762.54],"Cardio":[978.15,1218.77,882.57,806.35,951.5,2532.88,2922.87,1934.93,2072.17,1865.55,1359.45,1638.51,1038.37,855.97,1309.82,1277.1,891.61,1168.69,1023.59,9714.82,9641.39,4956.2,5040.72,4214.18,3077.17,4018.19,3227.97,3723.04,3443.76,4019.11],"CnO Pro":[2190.28,2771.74,4586.82,3765.83,3166.17,3799.86,3213.98,2432.22,2929.85,1202.4,672.38,487.66,790.16,710.66,929.23,867.02,1038.59,1737.87,5584.29,6053.84,4658.83,3186.26,4043.91,4030.78,3442.42,3247.48,4457.7,6892.16,3881.64,5749.32],"Respiratory":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],"Tesla":[6.9,13.7,20.85,0,9.14,6.9,9.0,7.67,6.9,0,0,6.9,13.7,0,13.8,27.6,7.86,0,6.8,9.0,6.9,7.69,0,6.9,6.9,6.9,8.0,6.9,16.39,24.49]},"subscriptions":{"AFib":[20,27,15,17,17,53,35,26,101,72,39,39,21,29,24,25,19,21,30,103,86,60,59,47,34,54,49,63,52,54],"Cardio":[92,103,92,96,102,150,166,122,289,243,170,163,114,127,124,119,108,106,106,453,430,260,236,210,161,201,170,212,195,218],"CnO Pro":[175,160,228,180,161,362,376,277,158,83,96,75,93,100,102,107,117,279,1172,696,466,345,320,286,234,218,243,295,238,332],"Respiratory":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],"Tesla":[1,2,3,0,1,1,1,1,1,0,0,1,2,0,2,4,1,0,1,1,1,1,0,1,1,1,1,1,2,3]}},"2025-12":{"dates":["2025-12-01","2025-12-02","2025-12-03","2025-12-04","2025-12-05","2025-12-06","2025-12-07","2025-12-08","2025-12-09","2025-12-10","2025-12-11","2025-12-12","2025-12-13","2025-12-14","2025-12-15","2025-12-16","2025-12-17","2025-12-18","2025-12-19","2025-12-20","2025-12-21","2025-12-22","2025-12-23","2025-12-24","2025-12-25","2025-12-26","2025-12-27","2025-12-28","2025-12-29","2025-12-30","2025-12-31"],"revenue":{"AFib":[3015.16,1154.21,637.3,689.98,580.5,489.67,865.75,893.81,1022.64,860.24,1203.18,698.68,1006.01,1152.71,605.02,1348.59,1067.57,611.95,573.15,1036.37,992.53,835.12,917.97,1121.28,965.32,1023.34,913.38,995.31,673.13,895.27,327.02],"Cardio":[3659.28,2098.87,1721.92,1355.8,2090.22,1573.89,1444.72,1283.78,1933.24,1917.55,2162.4,1557.49,1626.38,1454.72,1549.38,2032.57,1968.7,1815.42,2200.78,2699.86,1359.26,1939.01,1829.65,1808.06,2276.2,2132.33,1867.94,2051.19,1466.22,1393.81,1788.92],"CnO Pro":[4850.43,2118.56,13761.45,17648.8,11772.05,6101.71,5170.94,4724.41,4054.57,4078.34,4168.93,4227.51,4597.58,3933.42,4179.83,4742.85,4747.92,4188.48,8128.65,5814.77,5279.14,4762.9,5224.34,4773.69,4451.36,5795.54,5931.33,6005.67,3861.65,5323.61,2442.25],"Respiratory":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,390.83,2861.03,651.36,0,0,37.65,121.33,358.16,334.46,335.69,195.55,190.78,353.03,733.36,2637.31],"Tesla":[23.32,29.5,46.73,6.9,18.5,0,9.09,15.63,6.9,0,6.9,16.16,13.7,0,13.8,20.7,17.38,0,6.8,79.28,6.9,7.89,0,6.9,75.9,6.9,7.99,6.9,6.9,23.41,15.15]},"subscriptions":{"AFib":[56,35,21,26,24,23,34,34,56,48,46,34,27,38,23,33,24,27,26,29,29,26,27,29,28,32,29,37,36,25,17],"Cardio":[173,137,129,119,148,128,122,131,241,217,178,140,123,138,127,140,141,132,152,163,118,146,126,112,135,136,112,162,129,104,98],"CnO Pro":[248,161,501,546,422,432,408,340,218,182,201,198,207,192,198,202,241,329,1163,681,487,386,374,307,287,297,299,306,256,295,171],"Respiratory":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,15,133,27,0,0,9,28,88,71,81,47,46,83,75,110],"Tesla":[3,4,6,1,2,0,1,2,1,0,1,2,2,0,2,3,2,0,1,2,1,1,0,1,2,1,1,1,1,3,2]}},"2026-01":{"dates":["2026-01-01","2026-01-02","2026-01-03","2026-01-04","2026-01-05","2026-01-06","2026-01-07","2026-01-08","2026-01-09","2026-01-10","2026-01-11","2026-01-12","2026-01-13","2026-01-14","2026-01-15","2026-01-16","2026-01-17","2026-01-18","2026-01-19","2026-01-20","2026-01-21","2026-01-22","2026-01-23","2026-01-24","2026-01-25","2026-01-26","2026-01-27","2026-01-28","2026-01-29","2026-01-30","2026-01-31"],"revenue":{"AFib":[317.75,639.79,502.27,516.43,551.27,502.46,745.81,823.06,901.54,722.19,683.9,805.87,729.33,951.13,532.31,665.38,840.09,554.14,606.25,365.64,659.04,409.74,628.75,750.35,843.81,583.29,590.61,926.85,712.41,769.11,663.39],"Cardio":[1791.08,1793.46,1354.6,1611.86,1082.33,1479.98,1231.99,1654.62,1442.95,1629.9,1551.14,1652.07,1277.17,1497.77,1371.37,1610.86,1715.44,1408.15,1544.74,1176.41,1319.99,1540.78,1469.0,1621.34,1639.07,1388.96,1433.12,1734.29,1714.96,1122.71,1849.17],"CnO Pro":[5000.77,4728.32,4009.15,4461.56,4013.03,4754.52,4919.65,4872.18,4734.47,4775.19,3102.16,4593.4,3573.32,3406.54,4243.18,3858.17,4466.11,3951.85,7075.55,5116.62,4645.99,4728.03,3868.36,4196.51,4538.37,3691.36,3978.2,4373.14,3763.07,3903.7,3057.97],"Respiratory":[1872.93,2517.77,2025.73,1343.32,2320.55,2894.41,1345.14,1213.17,1372.32,1147.69,1447.18,1504.74,1337.58,1138.14,974.35,963.17,2670.13,1740.77,4312.77,3817.76,2297.57,1664.8,1930.21,12258.23,7530.83,11908.08,11491.24,7300.76,4941.54,5969.79,3781.23],"Tesla":[18.05,97.07,46.2,6.9,18.6,9.27,9.14,15.69,16.17,0,0,9.27,13.7,6.9,6.9,20.7,18.95,85.51,6.8,6.9,13.7,14.66,0,20.7,15.69,75.9,77.0,14.6,6.9,19.25,39.08]},"subscriptions":{"AFib":[24,28,19,23,24,19,31,31,51,38,38,36,26,39,22,34,25,30,32,24,30,21,30,20,29,28,30,33,34,24,25],"Cardio":[135,139,113,124,113,130,116,138,198,183,151,141,106,137,139,147,135,125,135,121,119,141,118,122,112,126,100,156,148,100,105],"CnO Pro":[318,274,301,266,258,387,404,339,265,234,200,258,215,220,245,223,260,351,1085,676,486,422,362,316,325,281,299,309,298,318,229],"Respiratory":[90,94,79,71,92,103,59,63,59,54,69,105,89,71,62,54,415,244,571,515,307,223,226,461,316,456,392,274,245,246,193],"Tesla":[2,4,6,1,2,1,1,2,2,0,0,1,2,1,1,3,2,3,1,1,2,2,0,3,2,2,2,2,1,2,5]}},"2026-02":{"dates":["2026-02-01","2026-02-02","2026-02-03","2026-02-04","2026-02-05","2026-02-06","2026-02-07","2026-02-08","2026-02-09","2026-02-10","2026-02-11","2026-02-12","2026-02-13","2026-02-14","2026-02-15","2026-02-16","2026-02-17","2026-02-18","2026-02-19","2026-02-20"],"revenue":{"AFib":[686.96,613.57,329.91,785.72,668.03,450.0,746.32,610.48,633.67,999.86,705.75,417.56,572.19,374.39,283.52,119.65,412.37,433.92,653.24,178.27],"Cardio":[1465.92,1188.19,1479.61,1425.37,1702.24,1308.03,1653.48,1480.26,1870.22,1201.89,1214.01,1472.61,1174.62,1148.78,1060.91,1327.61,901.66,1162.04,1111.31,462.71],"CnO Pro":[3721.02,4062.63,4084.38,3829.93,4370.24,5303.23,3966.06,3799.18,3912.1,4260.44,3646.63,4479.25,4527.68,4207.38,3831.28,3495.6,3597.64,4106.62,7082.72,2490.49],"Respiratory":[3597.25,4445.25,2693.53,2858.68,3160.11,2068.58,2036.85,2471.88,1294.34,1898.47,1294.23,1588.34,1163.72,1376.25,1798.37,1473.39,2014.54,2081.06,2465.52,1167.38],"Tesla":[11.03,21.65,39.18,0,25.64,7.71,9.34,7.9,6.9,95.54,7.95,9.35,13.7,0,13.8,20.7,9.7,7.26,13.7,0]},"subscriptions":{"AFib":[25,23,19,33,28,19,25,29,44,41,38,29,23,21,20,20,19,32,28,16],"Cardio":[122,118,118,120,143,122,133,122,205,152,135,132,118,135,125,130,102,113,117,55],"CnO Pro":[302,280,313,264,292,403,390,322,268,246,235,282,252,253,255,248,271,368,1042,317],"Respiratory":[166,166,140,138,135,106,99,123,89,102,73,104,82,87,96,87,255,201,357,180],"Tesla":[1,3,5,0,3,1,1,1,1,2,1,1,2,0,2,3,1,1,2,0]}}};

const PURCHASE_DATA = {"2025-09":{"dates":["2025-09-01","2025-09-02","2025-09-03","2025-09-04","2025-09-05","2025-09-06","2025-09-07","2025-09-08","2025-09-09","2025-09-10","2025-09-11","2025-09-12","2025-09-13","2025-09-14","2025-09-15","2025-09-16","2025-09-17","2025-09-18","2025-09-19","2025-09-20","2025-09-21","2025-09-22","2025-09-23","2025-09-24","2025-09-25","2025-09-26","2025-09-27","2025-09-28","2025-09-29","2025-09-30"],"purchases":{"AFib":[16,20,13,20,10,25,15,13,14,13,18,18,16,16,12,26,21,24,35,24,31,33,40,33,19,18,16,27,21,18],"Cardio":[146,136,164,150,144,125,142,144,140,125,128,139,122,150,135,142,120,124,134,127,107,149,110,106,104,140,119,149,133,151],"CnO Pro":[152,154,172,126,125,116,104,117,103,96,111,112,94,72,98,84,91,297,1381,737,478,365,342,253,262,243,233,247,232,289],"Respiratory":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],"Tesla":[1,2,3,2,2,1,1,3,2,0,1,1,3,1,1,3,0,1,1,3,1,0,2,2,3,0,3,0,1,6]}},"2025-10":{"dates":["2025-10-01","2025-10-02","2025-10-03","2025-10-04","2025-10-05","2025-10-06","2025-10-07","2025-10-08","2025-10-09","2025-10-10","2025-10-11","2025-10-12","2025-10-13","2025-10-14","2025-10-15","2025-10-16","2025-10-17","2025-10-18","2025-10-19","2025-10-20","2025-10-21","2025-10-22","2025-10-23","2025-10-24","2025-10-25","2025-10-26","2025-10-27","2025-10-28","2025-10-29","2025-10-30","2025-10-31"],"purchases":{"AFib":[19,17,15,18,15,19,23,12,13,18,16,18,13,16,15,22,11,19,17,14,26,20,18,17,13,21,14,19,21,14,10],"Cardio":[139,121,127,133,123,130,137,132,159,144,135,113,118,133,109,118,97,108,98,98,84,106,78,102,88,109,75,110,103,100,48],"CnO Pro":[220,214,224,187,186,178,196,204,170,167,171,151,139,147,133,117,146,305,1278,701,490,356,311,273,221,204,212,177,176,188,132],"Respiratory":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],"Tesla":[2,2,3,1,1,1,0,3,1,0,1,2,3,0,2,3,1,2,1,3,1,0,0,2,2,0,2,0,2,5,1]}},"2025-11":{"dates":["2025-11-01","2025-11-02","2025-11-03","2025-11-04","2025-11-05","2025-11-06","2025-11-07","2025-11-08","2025-11-09","2025-11-10","2025-11-11","2025-11-12","2025-11-13","2025-11-14","2025-11-15","2025-11-16","2025-11-17","2025-11-18","2025-11-19","2025-11-20","2025-11-21","2025-11-22","2025-11-23","2025-11-24","2025-11-25","2025-11-26","2025-11-27","2025-11-28","2025-11-29","2025-11-30"],"purchases":{"AFib":[20,27,15,17,17,53,35,26,101,72,39,39,21,29,24,25,19,21,30,103,86,60,59,47,34,54,49,63,52,54],"Cardio":[92,103,92,96,102,150,166,122,289,243,170,163,114,127,124,119,108,106,106,453,430,260,236,210,161,201,170,212,195,218],"CnO Pro":[175,160,228,180,161,362,376,277,158,83,96,75,93,100,102,107,117,279,1172,696,466,345,320,286,234,218,243,295,238,332],"Respiratory":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],"Tesla":[1,2,3,0,1,1,1,1,1,0,0,1,2,0,2,4,1,0,1,1,1,1,0,1,1,1,1,1,2,3]}},"2025-12":{"dates":["2025-12-01","2025-12-02","2025-12-03","2025-12-04","2025-12-05","2025-12-06","2025-12-07","2025-12-08","2025-12-09","2025-12-10","2025-12-11","2025-12-12","2025-12-13","2025-12-14","2025-12-15","2025-12-16","2025-12-17","2025-12-18","2025-12-19","2025-12-20","2025-12-21","2025-12-22","2025-12-23","2025-12-24","2025-12-25","2025-12-26","2025-12-27","2025-12-28","2025-12-29","2025-12-30","2025-12-31"],"purchases":{"AFib":[56,35,21,26,24,23,34,34,56,48,46,34,27,38,23,33,24,27,26,29,29,26,27,29,28,32,29,37,36,25,17],"Cardio":[173,137,129,119,148,128,122,131,241,217,178,140,123,138,127,140,141,132,152,163,118,146,126,112,135,136,112,162,129,104,98],"CnO Pro":[248,161,501,546,422,432,408,340,218,182,201,198,207,192,198,202,241,329,1163,681,487,386,374,307,287,297,299,306,256,295,171],"Respiratory":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,15,133,27,0,0,9,28,88,71,81,47,46,83,75,110],"Tesla":[3,4,6,1,2,0,1,2,1,0,1,2,2,0,2,3,2,0,1,2,1,1,0,1,2,1,1,1,1,3,2]}},"2026-01":{"dates":["2026-01-01","2026-01-02","2026-01-03","2026-01-04","2026-01-05","2026-01-06","2026-01-07","2026-01-08","2026-01-09","2026-01-10","2026-01-11","2026-01-12","2026-01-13","2026-01-14","2026-01-15","2026-01-16","2026-01-17","2026-01-18","2026-01-19","2026-01-20","2026-01-21","2026-01-22","2026-01-23","2026-01-24","2026-01-25","2026-01-26","2026-01-27","2026-01-28","2026-01-29","2026-01-30","2026-01-31"],"purchases":{"AFib":[24,28,19,23,24,19,31,31,51,38,38,36,26,39,22,34,25,30,32,24,30,21,30,20,29,28,30,33,34,24,25],"Cardio":[135,139,113,124,113,130,116,138,198,183,151,141,106,137,139,147,135,125,135,121,119,141,118,122,112,126,100,156,148,100,105],"CnO Pro":[318,274,301,266,258,387,404,339,265,234,200,258,215,220,245,223,260,351,1085,676,486,422,362,316,325,281,299,309,298,318,229],"Respiratory":[90,94,79,71,92,103,59,63,59,54,69,105,89,71,62,54,415,244,571,515,307,223,226,461,316,456,392,274,245,246,193],"Tesla":[2,4,6,1,2,1,1,2,2,0,0,1,2,1,1,3,2,3,1,1,2,2,0,3,2,2,2,2,1,2,5]}},"2026-02":{"dates":["2026-02-01","2026-02-02","2026-02-03","2026-02-04","2026-02-05","2026-02-06","2026-02-07","2026-02-08","2026-02-09","2026-02-10","2026-02-11","2026-02-12","2026-02-13","2026-02-14","2026-02-15","2026-02-16","2026-02-17","2026-02-18","2026-02-19","2026-02-20"],"purchases":{"AFib":[25,23,19,33,28,19,25,29,44,41,38,29,23,21,20,20,19,32,28,16],"Cardio":[122,118,118,120,143,122,133,122,205,152,135,132,118,135,125,130,102,113,117,55],"CnO Pro":[302,280,313,264,292,403,390,322,268,246,235,282,252,253,255,248,271,368,1042,317],"Respiratory":[166,166,140,138,135,106,99,123,89,102,73,104,82,87,96,87,255,201,357,180],"Tesla":[1,3,5,0,3,1,1,1,1,2,1,1,2,0,2,3,1,1,2,0]}}};

// Country-wise revenue data (injected by refresh_dashboard.py)
// Format: { "2025-09": { "USA": {"AFib": 1234, ...}, "India": {...}, "_total": {...} }, ... }
const COUNTRY_REVENUE_DATA = {"2025-09":{"USA":{"AFib":819.0,"Cardio":7241.28,"CnO Pro":32826.18,"Respiratory":0,"Tesla":276.0},"India":{"AFib":243.22,"Cardio":1925.87,"CnO Pro":3.95,"Respiratory":0,"Tesla":0},"Canada":{"AFib":491.18,"Cardio":679.34,"CnO Pro":4123.95,"Respiratory":0,"Tesla":7.15},"UK + IR":{"AFib":1658.75,"Cardio":988.78,"CnO Pro":5211.56,"Respiratory":0,"Tesla":18.64},"Australia":{"AFib":156.43,"Cardio":534.88,"CnO Pro":4328.45,"Respiratory":0,"Tesla":65.24},"Germany":{"AFib":523.8,"Cardio":384.09,"CnO Pro":2314.74,"Respiratory":0,"Tesla":0},"UAE":{"AFib":54.43,"Cardio":404.17,"CnO Pro":24.49,"Respiratory":0,"Tesla":20.41},"Czech Republic":{"AFib":191.33,"Cardio":332.38,"CnO Pro":489.98,"Respiratory":0,"Tesla":9.59},"Thailand":{"AFib":5.6,"Cardio":264.0,"CnO Pro":0,"Respiratory":0,"Tesla":0},"Switzerland":{"AFib":548.54,"Cardio":173.55,"CnO Pro":605.81,"Respiratory":0,"Tesla":0},"Spain":{"AFib":73.06,"Cardio":162.92,"CnO Pro":267.17,"Respiratory":0,"Tesla":0},"Netherlands":{"AFib":186.77,"Cardio":208.7,"CnO Pro":1113.55,"Respiratory":0,"Tesla":0},"Singapore":{"AFib":87.03,"Cardio":263.77,"CnO Pro":4.65,"Respiratory":0,"Tesla":7.76},"Philippines":{"AFib":0,"Cardio":199.45,"CnO Pro":3.48,"Respiratory":0,"Tesla":0},"Other":{"AFib":1874.41,"Cardio":3115.72,"CnO Pro":4062.04,"Respiratory":0,"Tesla":61.14},"_total":{"AFib":6913.55,"Cardio":16878.9,"CnO Pro":55380.0,"Respiratory":0.0,"Tesla":465.93}},"2025-10":{"USA":{"AFib":323.3,"Cardio":7147.14,"CnO Pro":44174.76,"Respiratory":0,"Tesla":96.6},"India":{"AFib":67.76,"Cardio":1953.54,"CnO Pro":3.95,"Respiratory":0,"Tesla":15.82},"Canada":{"AFib":128.17,"Cardio":584.22,"CnO Pro":4762.59,"Respiratory":0,"Tesla":7.07},"UK + IR":{"AFib":949.79,"Cardio":801.19,"CnO Pro":6830.19,"Respiratory":0,"Tesla":18.44},"Australia":{"AFib":625.4,"Cardio":492.69,"CnO Pro":5823.19,"Respiratory":0,"Tesla":0},"Germany":{"AFib":479.98,"Cardio":353.69,"CnO Pro":1775.58,"Respiratory":0,"Tesla":0},"UAE":{"AFib":277.67,"Cardio":414.54,"CnO Pro":98.01,"Respiratory":0,"Tesla":27.22},"Czech Republic":{"AFib":233.3,"Cardio":283.82,"CnO Pro":199.64,"Respiratory":0,"Tesla":9.53},"Thailand":{"AFib":5.49,"Cardio":505.26,"CnO Pro":0,"Respiratory":0,"Tesla":0},"Switzerland":{"AFib":330.81,"Cardio":142.96,"CnO Pro":790.54,"Respiratory":0,"Tesla":0},"Spain":{"AFib":128.3,"Cardio":139.36,"CnO Pro":302.31,"Respiratory":0,"Tesla":0},"Netherlands":{"AFib":186.62,"Cardio":160.08,"CnO Pro":1051.47,"Respiratory":0,"Tesla":0},"Singapore":{"AFib":194.39,"Cardio":220.81,"CnO Pro":4.62,"Respiratory":0,"Tesla":7.7},"Philippines":{"AFib":0,"Cardio":94.75,"CnO Pro":3.41,"Respiratory":0,"Tesla":0},"Other":{"AFib":1887.02,"Cardio":2540.25,"CnO Pro":5139.67,"Respiratory":0,"Tesla":235.98},"_total":{"AFib":5818.0,"Cardio":15834.3,"CnO Pro":70959.93,"Respiratory":0.0,"Tesla":418.36}},"2025-11":{"USA":{"AFib":217.5,"Cardio":8595.25,"CnO Pro":18988.56,"Respiratory":0,"Tesla":75.9},"India":{"AFib":174.21,"Cardio":4811.45,"CnO Pro":23.55,"Respiratory":0,"Tesla":7.86},"Canada":{"AFib":176.24,"Cardio":2817.63,"CnO Pro":2656.75,"Respiratory":0,"Tesla":7.05},"UK + IR":{"AFib":5339.61,"Cardio":2665.36,"CnO Pro":3088.53,"Respiratory":0,"Tesla":0},"Australia":{"AFib":2030.9,"Cardio":1195.82,"CnO Pro":3493.51,"Respiratory":0,"Tesla":0},"Germany":{"AFib":2246.34,"Cardio":591.45,"CnO Pro":1039.55,"Respiratory":0,"Tesla":0},"UAE":{"AFib":1225.11,"Cardio":742.07,"CnO Pro":134.74,"Respiratory":0,"Tesla":20.41},"Czech Republic":{"AFib":1646.27,"Cardio":860.32,"CnO Pro":237.17,"Respiratory":0,"Tesla":18.99},"Thailand":{"AFib":66.37,"Cardio":1566.49,"CnO Pro":0,"Respiratory":0,"Tesla":7.69},"Switzerland":{"AFib":1449.45,"Cardio":505.88,"CnO Pro":668.86,"Respiratory":0,"Tesla":0},"Spain":{"AFib":653.95,"Cardio":246.41,"CnO Pro":302.54,"Respiratory":0,"Tesla":0},"Netherlands":{"AFib":557.39,"Cardio":327.37,"CnO Pro":1007.25,"Respiratory":0,"Tesla":0},"Singapore":{"AFib":956.69,"Cardio":633.98,"CnO Pro":201.2,"Respiratory":0,"Tesla":7.67},"Philippines":{"AFib":106.84,"Cardio":1275.06,"CnO Pro":99.42,"Respiratory":0,"Tesla":0},"Other":{"AFib":8128.41,"Cardio":8414.97,"CnO Pro":3944.56,"Respiratory":0,"Tesla":43.23},"_total":{"AFib":24975.28,"Cardio":35249.51,"CnO Pro":35886.19,"Respiratory":0.0,"Tesla":188.8}},"2025-12":{"USA":{"AFib":121.5,"Cardio":7965.48,"CnO Pro":33147.95,"Respiratory":3688.8,"Tesla":75.9},"India":{"AFib":105.43,"Cardio":3231.68,"CnO Pro":271.9,"Respiratory":496.84,"Tesla":7.77},"Canada":{"AFib":119.53,"Cardio":2769.49,"CnO Pro":7701.41,"Respiratory":663.05,"Tesla":86.17},"UK + IR":{"AFib":2658.95,"Cardio":1596.86,"CnO Pro":8529.19,"Respiratory":768.48,"Tesla":18.48},"Australia":{"AFib":1250.87,"Cardio":1619.07,"CnO Pro":8186.43,"Respiratory":618.84,"Tesla":0},"Germany":{"AFib":1246.9,"Cardio":682.71,"CnO Pro":3400.27,"Respiratory":136.75,"Tesla":9.26},"UAE":{"AFib":642.46,"Cardio":850.97,"CnO Pro":1196.53,"Respiratory":145.63,"Tesla":20.41},"Czech Republic":{"AFib":478.78,"Cardio":466.27,"CnO Pro":655.15,"Respiratory":371.42,"Tesla":19.22},"Thailand":{"AFib":17.03,"Cardio":537.65,"CnO Pro":382.38,"Respiratory":95.41,"Tesla":15.79},"Switzerland":{"AFib":305.36,"Cardio":484.16,"CnO Pro":1337.98,"Respiratory":91.91,"Tesla":0},"Spain":{"AFib":492.99,"Cardio":347.0,"CnO Pro":505.6,"Respiratory":56.68,"Tesla":0},"Netherlands":{"AFib":546.82,"Cardio":496.7,"CnO Pro":1606.11,"Respiratory":108.23,"Tesla":0},"Singapore":{"AFib":243.8,"Cardio":102.0,"CnO Pro":671.78,"Respiratory":31.67,"Tesla":7.73},"Philippines":{"AFib":16.93,"Cardio":420.36,"CnO Pro":613.6,"Respiratory":25.67,"Tesla":0},"Other":{"AFib":3510.32,"Cardio":4055.4,"CnO Pro":12226.42,"Respiratory":1314.82,"Tesla":76.71},"_total":{"AFib":11757.67,"Cardio":25625.8,"CnO Pro":80432.7,"Respiratory":8614.2,"Tesla":337.44}},"2026-01":{"USA":{"AFib":207.7,"Cardio":8724.98,"CnO Pro":36926.69,"Respiratory":47567.91,"Tesla":131.1},"India":{"AFib":148.59,"Cardio":3005.74,"CnO Pro":396.71,"Respiratory":2863.21,"Tesla":7.7},"Canada":{"AFib":104.81,"Cardio":3969.36,"CnO Pro":9920.01,"Respiratory":7437.16,"Tesla":28.73},"UK + IR":{"AFib":2891.56,"Cardio":1896.91,"CnO Pro":7749.35,"Respiratory":6049.97,"Tesla":27.98},"Australia":{"AFib":1360.63,"Cardio":1605.51,"CnO Pro":8977.63,"Respiratory":5211.94,"Tesla":6.71},"Germany":{"AFib":961.28,"Cardio":630.42,"CnO Pro":3149.31,"Respiratory":2252.7,"Tesla":9.27},"UAE":{"AFib":631.54,"Cardio":575.43,"CnO Pro":1343.51,"Respiratory":1720.58,"Tesla":27.22},"Czech Republic":{"AFib":572.53,"Cardio":502.02,"CnO Pro":351.41,"Respiratory":1080.65,"Tesla":28.87},"Thailand":{"AFib":11.43,"Cardio":616.09,"CnO Pro":180.72,"Respiratory":1521.97,"Tesla":15.9},"Switzerland":{"AFib":679.97,"Cardio":405.81,"CnO Pro":1494.62,"Respiratory":1301.21,"Tesla":0},"Spain":{"AFib":299.66,"Cardio":182.18,"CnO Pro":562.67,"Respiratory":502.11,"Tesla":0},"Netherlands":{"AFib":353.45,"Cardio":169.51,"CnO Pro":1308.14,"Respiratory":530.99,"Tesla":0},"Singapore":{"AFib":76.34,"Cardio":181.26,"CnO Pro":512.73,"Respiratory":1513.56,"Tesla":7.79},"Philippines":{"AFib":21.05,"Cardio":394.0,"CnO Pro":574.25,"Respiratory":2147.85,"Tesla":0},"Other":{"AFib":3594.23,"Cardio":4452.7,"CnO Pro":11213.15,"Respiratory":14043.91,"Tesla":253.35},"_total":{"AFib":11914.77,"Cardio":27311.92,"CnO Pro":84660.9,"Respiratory":95745.72,"Tesla":544.62}},"2026-02":{"USA":{"AFib":77.4,"Cardio":5979.75,"CnO Pro":22173.63,"Respiratory":15068.85,"Tesla":34.5},"India":{"AFib":22.01,"Cardio":1530.14,"CnO Pro":448.57,"Respiratory":1080.46,"Tesla":7.71},"Canada":{"AFib":136.54,"Cardio":1668.92,"CnO Pro":9124.75,"Respiratory":2827.29,"Tesla":14.51},"UK + IR":{"AFib":1650.27,"Cardio":1236.58,"CnO Pro":6046.43,"Respiratory":2930.64,"Tesla":9.39},"Australia":{"AFib":623.17,"Cardio":691.96,"CnO Pro":6542.18,"Respiratory":1621.9,"Tesla":0},"Germany":{"AFib":783.79,"Cardio":430.79,"CnO Pro":2256.13,"Respiratory":643.71,"Tesla":9.35},"UAE":{"AFib":386.56,"Cardio":357.95,"CnO Pro":677.87,"Respiratory":843.94,"Tesla":27.22},"Czech Republic":{"AFib":173.06,"Cardio":323.59,"CnO Pro":345.09,"Respiratory":174.57,"Tesla":9.7},"Thailand":{"AFib":5.71,"Cardio":337.06,"CnO Pro":158.03,"Respiratory":908.24,"Tesla":15.9},"Switzerland":{"AFib":356.34,"Cardio":322.44,"CnO Pro":604.51,"Respiratory":617.96,"Tesla":0},"Spain":{"AFib":303.03,"Cardio":266.55,"CnO Pro":283.6,"Respiratory":468.29,"Tesla":88.74},"Netherlands":{"AFib":110.72,"Cardio":113.94,"CnO Pro":926.77,"Respiratory":165.7,"Tesla":0},"Singapore":{"AFib":270.35,"Cardio":143.75,"CnO Pro":270.75,"Respiratory":226.06,"Tesla":0},"Philippines":{"AFib":12.8,"Cardio":308.31,"CnO Pro":245.29,"Respiratory":835.21,"Tesla":0},"Other":{"AFib":2130.35,"Cardio":2639.35,"CnO Pro":7475.86,"Respiratory":5043.92,"Tesla":48.84},"_total":{"AFib":7042.1,"Cardio":16351.08,"CnO Pro":57579.46,"Respiratory":33456.74,"Tesla":265.86}}};

// Trial vs Converted data from Metabase (injected by refresh_dashboard.py)
const TRIAL_DATA = {"AFib":{"2025-09":{"dates":["2025-09-01","2025-09-02","2025-09-03","2025-09-04","2025-09-05","2025-09-06","2025-09-07","2025-09-08","2025-09-09","2025-09-10","2025-09-11","2025-09-12","2025-09-13","2025-09-14","2025-09-15","2025-09-16","2025-09-17","2025-09-18","2025-09-19","2025-09-20","2025-09-21","2025-09-22","2025-09-23","2025-09-24","2025-09-25","2025-09-26","2025-09-27","2025-09-28","2025-09-29","2025-09-30"],"trial":[4,3,2,6,3,8,6,4,7,2,4,6,3,4,28,37,39,29,28,28,28,23,24,12,4,4,8,8,4,0],"converted":[2,1,1,4,0,6,4,3,6,1,3,5,0,4,20,29,28,20,19,19,17,9,12,8,3,3,8,6,4,0]},"2025-10":{"dates":["2025-10-01","2025-10-02","2025-10-03","2025-10-04","2025-10-05","2025-10-06","2025-10-07","2025-10-08","2025-10-09","2025-10-10","2025-10-11","2025-10-12","2025-10-13","2025-10-14","2025-10-15","2025-10-16","2025-10-17","2025-10-18","2025-10-19","2025-10-20","2025-10-21","2025-10-22","2025-10-23","2025-10-24","2025-10-25","2025-10-26","2025-10-27","2025-10-28","2025-10-29","2025-10-30","2025-10-31"],"trial":[9,6,9,13,9,9,6,3,7,5,4,5,10,6,8,9,9,12,9,8,11,3,11,10,6,9,3,4,5,10,0],"converted":[7,3,8,7,4,6,5,2,6,2,4,5,7,3,6,7,7,8,8,5,8,3,9,8,5,7,2,3,5,6,0]},"2025-11":{"dates":["2025-11-01","2025-11-02","2025-11-03","2025-11-04","2025-11-05","2025-11-06","2025-11-07","2025-11-08","2025-11-09","2025-11-10","2025-11-11","2025-11-12","2025-11-13","2025-11-14","2025-11-15","2025-11-16","2025-11-17","2025-11-18","2025-11-19","2025-11-20","2025-11-21","2025-11-22","2025-11-23","2025-11-24","2025-11-25","2025-11-26","2025-11-27","2025-11-28","2025-11-29","2025-11-30"],"trial":[8,5,5,5,6,370,396,170,117,56,67,46,52,25,29,28,27,26,20,39,21,22,21,15,27,23,19,10,15,0],"converted":[6,5,4,5,6,130,152,69,43,22,35,27,25,12,12,18,14,15,10,17,10,12,9,7,18,16,8,7,11,0]},"2025-12":{"dates":["2025-12-01","2025-12-02","2025-12-03","2025-12-04","2025-12-05","2025-12-06","2025-12-07","2025-12-08","2025-12-09","2025-12-10","2025-12-11","2025-12-12","2025-12-13","2025-12-14","2025-12-15","2025-12-16","2025-12-17","2025-12-18","2025-12-19","2025-12-20","2025-12-21","2025-12-22","2025-12-23","2025-12-24","2025-12-25","2025-12-26","2025-12-27","2025-12-28","2025-12-29","2025-12-30","2025-12-31"],"trial":[11,6,3,12,23,14,10,11,11,4,7,4,3,9,4,8,10,7,12,12,9,10,10,18,19,14,13,7,16,10,0],"converted":[11,4,2,9,11,5,8,5,5,4,4,2,1,8,2,6,9,2,10,6,7,8,8,12,17,8,7,4,9,6,0]},"2026-01":{"dates":["2026-01-01","2026-01-02","2026-01-03","2026-01-04","2026-01-05","2026-01-06","2026-01-07","2026-01-08","2026-01-09","2026-01-10","2026-01-11","2026-01-12","2026-01-13","2026-01-14","2026-01-15","2026-01-16","2026-01-17","2026-01-18","2026-01-19","2026-01-20","2026-01-21","2026-01-22","2026-01-23","2026-01-24","2026-01-25","2026-01-26","2026-01-27","2026-01-28","2026-01-29","2026-01-30","2026-01-31"],"trial":[7,14,9,16,13,16,15,18,17,19,24,14,29,23,19,21,20,16,14,15,17,20,21,32,20,13,16,16,10,8,0],"converted":[5,6,3,7,6,12,7,11,8,10,14,7,14,16,8,11,12,11,6,8,6,12,10,20,15,9,8,9,5,3,0]},"2026-02":{"dates":["2026-02-01","2026-02-02","2026-02-03","2026-02-04","2026-02-05","2026-02-06","2026-02-07","2026-02-08","2026-02-09","2026-02-10","2026-02-11","2026-02-12","2026-02-13","2026-02-14","2026-02-15","2026-02-16","2026-02-17","2026-02-18","2026-02-19","2026-02-20"],"trial":[4,8,8,11,6,6,5,6,8,9,7,11,8,11,6,8,9,9,5,0],"converted":[4,8,4,8,4,4,3,3,3,6,1,4,2,4,4,2,6,1,0,0]}},"Cardio":{"2025-09":{"dates":["2025-09-01","2025-09-02","2025-09-03","2025-09-04","2025-09-05","2025-09-06","2025-09-07","2025-09-08","2025-09-09","2025-09-10","2025-09-11","2025-09-12","2025-09-13","2025-09-14","2025-09-15","2025-09-16","2025-09-17","2025-09-18","2025-09-19","2025-09-20","2025-09-21","2025-09-22","2025-09-23","2025-09-24","2025-09-25","2025-09-26","2025-09-27","2025-09-28","2025-09-29","2025-09-30"],"trial":[18,21,17,32,19,25,31,27,16,20,13,25,19,21,26,14,18,20,19,18,13,21,25,32,25,27,25,23,25,0],"converted":[13,15,15,24,11,18,23,22,14,14,9,17,13,18,17,10,15,15,16,15,13,18,20,29,24,25,19,17,23,0]},"2025-10":{"dates":["2025-10-01","2025-10-02","2025-10-03","2025-10-04","2025-10-05","2025-10-06","2025-10-07","2025-10-08","2025-10-09","2025-10-10","2025-10-11","2025-10-12","2025-10-13","2025-10-14","2025-10-15","2025-10-16","2025-10-17","2025-10-18","2025-10-19","2025-10-20","2025-10-21","2025-10-22","2025-10-23","2025-10-24","2025-10-25","2025-10-26","2025-10-27","2025-10-28","2025-10-29","2025-10-30","2025-10-31"],"trial":[17,26,35,21,22,23,22,20,22,19,14,14,27,25,17,18,10,23,21,21,23,25,18,16,11,18,15,16,19,23,0],"converted":[13,19,32,18,15,22,21,16,18,14,12,9,22,19,15,14,10,20,16,16,17,19,16,13,10,15,11,9,18,20,0]},"2025-11":{"dates":["2025-11-01","2025-11-02","2025-11-03","2025-11-04","2025-11-05","2025-11-06","2025-11-07","2025-11-08","2025-11-09","2025-11-10","2025-11-11","2025-11-12","2025-11-13","2025-11-14","2025-11-15","2025-11-16","2025-11-17","2025-11-18","2025-11-19","2025-11-20","2025-11-21","2025-11-22","2025-11-23","2025-11-24","2025-11-25","2025-11-26","2025-11-27","2025-11-28","2025-11-29","2025-11-30"],"trial":[16,20,19,16,24,856,787,360,253,186,133,133,95,78,75,81,65,67,64,71,85,76,64,52,54,57,56,33,24,0],"converted":[13,18,13,15,21,502,514,237,172,130,91,85,63,62,49,59,50,42,47,47,51,49,37,37,37,42,38,22,18,0]},"2025-12":{"dates":["2025-12-01","2025-12-02","2025-12-03","2025-12-04","2025-12-05","2025-12-06","2025-12-07","2025-12-08","2025-12-09","2025-12-10","2025-12-11","2025-12-12","2025-12-13","2025-12-14","2025-12-15","2025-12-16","2025-12-17","2025-12-18","2025-12-19","2025-12-20","2025-12-21","2025-12-22","2025-12-23","2025-12-24","2025-12-25","2025-12-26","2025-12-27","2025-12-28","2025-12-29","2025-12-30","2025-12-31"],"trial":[30,33,45,36,97,56,37,34,34,29,39,23,22,20,21,21,33,32,20,38,34,33,30,40,77,52,47,58,53,44,0],"converted":[23,27,34,29,58,40,26,20,27,21,28,16,14,16,17,16,26,26,14,26,22,14,19,29,66,41,34,33,40,28,0]},"2026-01":{"dates":["2026-01-01","2026-01-02","2026-01-03","2026-01-04","2026-01-05","2026-01-06","2026-01-07","2026-01-08","2026-01-09","2026-01-10","2026-01-11","2026-01-12","2026-01-13","2026-01-14","2026-01-15","2026-01-16","2026-01-17","2026-01-18","2026-01-19","2026-01-20","2026-01-21","2026-01-22","2026-01-23","2026-01-24","2026-01-25","2026-01-26","2026-01-27","2026-01-28","2026-01-29","2026-01-30","2026-01-31"],"trial":[45,52,46,42,47,44,44,41,37,57,52,62,57,72,71,65,56,60,57,48,59,66,65,79,51,52,42,47,34,32,0],"converted":[29,36,31,31,28,28,22,27,23,29,33,37,30,49,39,37,36,38,39,30,38,37,39,51,32,31,34,32,24,11,0]},"2026-02":{"dates":["2026-02-01","2026-02-02","2026-02-03","2026-02-04","2026-02-05","2026-02-06","2026-02-07","2026-02-08","2026-02-09","2026-02-10","2026-02-11","2026-02-12","2026-02-13","2026-02-14","2026-02-15","2026-02-16","2026-02-17","2026-02-18","2026-02-19","2026-02-20"],"trial":[22,27,27,32,17,28,26,23,20,31,23,24,23,31,17,19,16,22,24,0],"converted":[15,19,13,26,12,17,6,7,11,17,9,14,10,13,9,9,6,3,0,0]}},"CnO Pro":{"2025-09":{"dates":["2025-09-01","2025-09-02","2025-09-03","2025-09-04","2025-09-05","2025-09-06","2025-09-07","2025-09-08","2025-09-09","2025-09-10","2025-09-11","2025-09-12","2025-09-13","2025-09-14","2025-09-15","2025-09-16","2025-09-17","2025-09-18","2025-09-19","2025-09-20","2025-09-21","2025-09-22","2025-09-23","2025-09-24","2025-09-25","2025-09-26","2025-09-27","2025-09-28","2025-09-29","2025-09-30"],"trial":[94,102,92,103,82,73,56,72,72,65,39,65,51,63,95,80,86,126,177,158,144,176,158,159,149,103,121,112,134,0],"converted":[82,86,83,94,74,64,50,70,67,60,38,64,46,57,87,76,83,111,153,138,125,163,142,145,134,95,106,101,120,0]},"2025-10":{"dates":["2025-10-01","2025-10-02","2025-10-03","2025-10-04","2025-10-05","2025-10-06","2025-10-07","2025-10-08","2025-10-09","2025-10-10","2025-10-11","2025-10-12","2025-10-13","2025-10-14","2025-10-15","2025-10-16","2025-10-17","2025-10-18","2025-10-19","2025-10-20","2025-10-21","2025-10-22","2025-10-23","2025-10-24","2025-10-25","2025-10-26","2025-10-27","2025-10-28","2025-10-29","2025-10-30","2025-10-31"],"trial":[159,125,106,90,91,116,123,110,111,102,81,84,90,102,93,93,84,74,83,83,102,86,88,76,87,83,115,107,107,75,0],"converted":[132,112,90,79,84,105,107,93,102,90,75,78,78,90,83,77,77,66,76,78,90,78,78,67,76,75,100,94,96,64,0]},"2025-11":{"dates":["2025-11-01","2025-11-02","2025-11-03","2025-11-04","2025-11-05","2025-11-06","2025-11-07","2025-11-08","2025-11-09","2025-11-10","2025-11-11","2025-11-12","2025-11-13","2025-11-14","2025-11-15","2025-11-16","2025-11-17","2025-11-18","2025-11-19","2025-11-20","2025-11-21","2025-11-22","2025-11-23","2025-11-24","2025-11-25","2025-11-26","2025-11-27","2025-11-28","2025-11-29","2025-11-30"],"trial":[50,78,759,943,631,230,169,148,150,157,143,118,129,125,81,92,133,102,117,90,110,163,154,173,129,136,107,131,139,0],"converted":[45,70,602,742,456,170,131,119,123,118,113,101,112,96,70,72,105,76,92,69,86,137,122,147,103,117,84,106,120,0]},"2025-12":{"dates":["2025-12-01","2025-12-02","2025-12-03","2025-12-04","2025-12-05","2025-12-06","2025-12-07","2025-12-08","2025-12-09","2025-12-10","2025-12-11","2025-12-12","2025-12-13","2025-12-14","2025-12-15","2025-12-16","2025-12-17","2025-12-18","2025-12-19","2025-12-20","2025-12-21","2025-12-22","2025-12-23","2025-12-24","2025-12-25","2025-12-26","2025-12-27","2025-12-28","2025-12-29","2025-12-30","2025-12-31"],"trial":[177,162,143,137,145,120,107,113,139,139,104,99,119,98,123,123,103,99,89,107,102,125,115,124,180,153,149,167,155,144,0],"converted":[149,128,125,111,112,95,86,100,106,116,84,78,97,79,101,96,81,80,70,81,80,102,97,98,159,118,123,127,129,112,0]},"2026-01":{"dates":["2026-01-01","2026-01-02","2026-01-03","2026-01-04","2026-01-05","2026-01-06","2026-01-07","2026-01-08","2026-01-09","2026-01-10","2026-01-11","2026-01-12","2026-01-13","2026-01-14","2026-01-15","2026-01-16","2026-01-17","2026-01-18","2026-01-19","2026-01-20","2026-01-21","2026-01-22","2026-01-23","2026-01-24","2026-01-25","2026-01-26","2026-01-27","2026-01-28","2026-01-29","2026-01-30","2026-01-31"],"trial":[108,148,129,139,173,189,163,145,144,148,164,177,183,179,176,134,122,140,149,136,131,174,171,125,142,134,123,115,125,118,0],"converted":[88,123,102,102,138,158,129,104,117,112,125,138,148,146,127,112,83,105,104,94,53,51,60,49,40,41,32,30,33,24,0]},"2026-02":{"dates":["2026-02-01","2026-02-02","2026-02-03","2026-02-04","2026-02-05","2026-02-06","2026-02-07","2026-02-08","2026-02-09","2026-02-10","2026-02-11","2026-02-12","2026-02-13","2026-02-14","2026-02-15","2026-02-16","2026-02-17","2026-02-18","2026-02-19","2026-02-20"],"trial":[105,132,124,113,108,89,83,116,111,120,132,126,94,85,112,103,109,120,121,0],"converted":[30,31,33,31,29,27,24,26,28,38,33,30,34,3,1,1,1,4,2,0]}},"Respiratory":{"2025-12":{"dates":["2025-12-01","2025-12-02","2025-12-03","2025-12-04","2025-12-05","2025-12-06","2025-12-07","2025-12-08","2025-12-09","2025-12-10","2025-12-11","2025-12-12","2025-12-13","2025-12-14","2025-12-15","2025-12-16","2025-12-17","2025-12-18","2025-12-19","2025-12-20","2025-12-21","2025-12-22","2025-12-23","2025-12-24","2025-12-25","2025-12-26","2025-12-27","2025-12-28","2025-12-29","2025-12-30","2025-12-31"],"trial":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,11,92,269,445,320,213,159,283,263,153,137,109,136,158,135,120,0],"converted":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,27,131,271,183,103,70,139,133,82,80,67,65,71,75,65,0]},"2026-01":{"dates":["2026-01-01","2026-01-02","2026-01-03","2026-01-04","2026-01-05","2026-01-06","2026-01-07","2026-01-08","2026-01-09","2026-01-10","2026-01-11","2026-01-12","2026-01-13","2026-01-14","2026-01-15","2026-01-16","2026-01-17","2026-01-18","2026-01-19","2026-01-20","2026-01-21","2026-01-22","2026-01-23","2026-01-24","2026-01-25","2026-01-26","2026-01-27","2026-01-28","2026-01-29","2026-01-30","2026-01-31"],"trial":[97,120,93,120,239,192,137,120,98,1009,1247,1265,1645,1007,654,546,447,278,411,263,243,271,233,177,169,132,146,123,101,81,0],"converted":[49,64,44,62,122,105,82,60,58,372,593,573,845,505,353,286,256,157,212,138,149,138,102,100,89,64,75,67,60,48,0]},"2026-02":{"dates":["2026-02-01","2026-02-02","2026-02-03","2026-02-04","2026-02-05","2026-02-06","2026-02-07","2026-02-08","2026-02-09","2026-02-10","2026-02-11","2026-02-12","2026-02-13","2026-02-14","2026-02-15","2026-02-16","2026-02-17","2026-02-18","2026-02-19","2026-02-20"],"trial":[90,89,77,92,82,60,48,80,72,70,72,55,65,62,70,49,61,55,62,0],"converted":[56,56,42,52,45,29,14,38,33,25,23,13,17,0,1,0,1,0,0,0]}},"Tesla":{"2025-09":{"dates":["2025-09-01","2025-09-02","2025-09-03","2025-09-04","2025-09-05","2025-09-06","2025-09-07","2025-09-08","2025-09-09","2025-09-10","2025-09-11","2025-09-12","2025-09-13","2025-09-14","2025-09-15","2025-09-16","2025-09-17","2025-09-18","2025-09-19","2025-09-20","2025-09-21","2025-09-22","2025-09-23","2025-09-24","2025-09-25","2025-09-26","2025-09-27","2025-09-28","2025-09-29","2025-09-30"],"trial":[2,2,1,1,2,4,1,1,3,1,0,1,1,0,3,0,1,2,0,1,0,0,0,0,0,0,2,2,2,0],"converted":[2,1,1,0,2,4,0,1,0,0,0,0,1,0,1,0,0,1,0,0,0,0,0,0,0,0,2,1,1,0]},"2025-10":{"dates":["2025-10-01","2025-10-02","2025-10-03","2025-10-04","2025-10-05","2025-10-06","2025-10-07","2025-10-08","2025-10-09","2025-10-10","2025-10-11","2025-10-12","2025-10-13","2025-10-14","2025-10-15","2025-10-16","2025-10-17","2025-10-18","2025-10-19","2025-10-20","2025-10-21","2025-10-22","2025-10-23","2025-10-24","2025-10-25","2025-10-26","2025-10-27","2025-10-28","2025-10-29","2025-10-30","2025-10-31"],"trial":[0,1,0,0,0,1,0,2,1,1,0,1,1,1,1,1,4,0,0,0,1,1,0,0,0,0,0,0,0,1,0],"converted":[0,0,0,0,0,1,0,1,1,1,0,0,1,0,1,0,2,0,0,0,1,1,0,0,0,0,0,0,0,0,0]},"2025-11":{"dates":["2025-11-01","2025-11-02","2025-11-03","2025-11-04","2025-11-05","2025-11-06","2025-11-07","2025-11-08","2025-11-09","2025-11-10","2025-11-11","2025-11-12","2025-11-13","2025-11-14","2025-11-15","2025-11-16","2025-11-17","2025-11-18","2025-11-19","2025-11-20","2025-11-21","2025-11-22","2025-11-23","2025-11-24","2025-11-25","2025-11-26","2025-11-27","2025-11-28","2025-11-29","2025-11-30"],"trial":[0,0,1,0,0,0,0,0,0,1,0,2,1,0,1,0,0,0,0,0,0,1,0,2,2,3,1,2,0,0],"converted":[0,0,1,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,1,0,2,2,3,1,1,0,0]},"2025-12":{"dates":["2025-12-01","2025-12-02","2025-12-03","2025-12-04","2025-12-05","2025-12-06","2025-12-07","2025-12-08","2025-12-09","2025-12-10","2025-12-11","2025-12-12","2025-12-13","2025-12-14","2025-12-15","2025-12-16","2025-12-17","2025-12-18","2025-12-19","2025-12-20","2025-12-21","2025-12-22","2025-12-23","2025-12-24","2025-12-25","2025-12-26","2025-12-27","2025-12-28","2025-12-29","2025-12-30","2025-12-31"],"trial":[2,0,0,1,1,0,2,0,0,1,1,0,1,0,1,0,0,1,2,1,0,0,2,1,2,0,0,1,1,2,0],"converted":[1,0,0,0,1,0,1,0,0,1,1,0,0,0,0,0,0,0,1,0,0,0,1,1,2,0,0,1,0,1,0]},"2026-01":{"dates":["2026-01-01","2026-01-02","2026-01-03","2026-01-04","2026-01-05","2026-01-06","2026-01-07","2026-01-08","2026-01-09","2026-01-10","2026-01-11","2026-01-12","2026-01-13","2026-01-14","2026-01-15","2026-01-16","2026-01-17","2026-01-18","2026-01-19","2026-01-20","2026-01-21","2026-01-22","2026-01-23","2026-01-24","2026-01-25","2026-01-26","2026-01-27","2026-01-28","2026-01-29","2026-01-30","2026-01-31"],"trial":[0,1,0,0,0,1,0,1,1,2,2,5,3,2,6,0,1,0,2,0,0,2,2,5,0,0,0,1,0,0,0],"converted":[0,1,0,0,0,0,0,0,1,1,2,2,2,1,2,0,1,0,1,0,0,1,1,2,0,0,0,0,0,0,0]},"2026-02":{"dates":["2026-02-01","2026-02-02","2026-02-03","2026-02-04","2026-02-05","2026-02-06","2026-02-07","2026-02-08","2026-02-09","2026-02-10","2026-02-11","2026-02-12","2026-02-13","2026-02-14","2026-02-15","2026-02-16","2026-02-17","2026-02-18","2026-02-19","2026-02-20"],"trial":[0,0,2,1,0,2,2,1,0,2,3,1,0,2,1,0,0,0,0,0],"converted":[0,0,2,1,0,1,0,1,0,0,0,1,0,0,0,0,0,0,0,0]}}};
// Helper: get real trial/converted data for a PP + month (returns null if no real data)
function getTrialDataForMonth(plug, mk) { return TRIAL_DATA[plug]?.[mk] || null; }
function getMonthlyTrials(plug, mk) { const d = getTrialDataForMonth(plug, mk); return d ? sum(d.trial) : 0; }
function getMonthlyConverted(plug, mk) { const d = getTrialDataForMonth(plug, mk); return d ? sum(d.converted) : 0; }
function hasRealTrialData(plug) { return !!TRIAL_DATA[plug]; }

// ============================================================
// STATE & INIT
// ============================================================
let currentPP = 'All', currentMonth = '2026-02', charts = {};
Chart.register(ChartDataLabels);
Chart.defaults.color = '#666';
Chart.defaults.borderColor = 'rgba(255,255,255,0.05)';
Chart.defaults.font.family = "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif";
// Disable datalabels globally, enable per-chart
Chart.defaults.plugins.datalabels = { display: false };

async function init() {
  document.getElementById('lastUpdated').textContent = 'Feb 20, 2026 at 06:31 PM' || new Date().toLocaleString();
  const sel = document.getElementById('filterMonth');
  const allMonths = [...new Set([...Object.keys(REVENUE_DATA), ...Object.keys(PURCHASE_DATA)])].sort();
  sel.innerHTML = '<option value="all-time">All Time (Monthly)</option>';
  allMonths.forEach(m => {
    const opt = document.createElement('option');
    opt.value = m;
    const d = new Date(m + '-01');
    opt.textContent = d.toLocaleString('default', { month: 'long', year: 'numeric' });
    if (m === '2026-02') opt.selected = true;
    sel.appendChild(opt);
  });
  document.getElementById('filterPP').addEventListener('change', e => { currentPP = e.target.value; renderAll(); renderEmailTracker(); });
  document.getElementById('filterMonth').addEventListener('change', e => { currentMonth = e.target.value; renderAll(); });
  document.getElementById('filterCountry').addEventListener('change', e => { currentCountry = e.target.value; renderAll(); });

  // Render immediately with localStorage data
  renderAll();
  renderCountryGrid();
  renderEmailTracker();

  // Then sync from Google Sheets in background (if configured)
  if (SheetsAPI.enabled) {
    console.log('Syncing from Google Sheets...');
    try {
      await Promise.all([
        syncCampaignsFromSheets(),
        syncCountryDataFromSheets(),
        syncEmailsFromSheets(),
      ]);
      // Re-render with Sheets data
      renderAll();
      renderCountryGrid();
      renderEmailTracker();
      console.log('Google Sheets sync complete');
    } catch (e) {
      console.warn('Sheets sync failed, using localStorage:', e.message);
    }
  }
}

function renderAll() {
  renderKPIs(); renderUserStats(); renderRevenueChart(); renderPPLegend(); renderTrialChart(); renderConversionChart(); renderPurchaseChart(); renderInsights(); renderProjectionTable(); renderCampaignTracker(); renderCountryRevenue();
}

// ============================================================
// TAB SWITCHING
// ============================================================
function switchTab(tabId) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
  document.getElementById('tab-' + tabId).classList.add('active');
  event.target.classList.add('active');
}

// ============================================================
// HELPERS
// ============================================================
function getPlugs() { return currentPP === 'All' ? PLUGS : [currentPP]; }
function sum(arr) { return arr.reduce((a,b) => a+b, 0); }
function isAllTime() { return currentMonth === 'all-time'; }
function getMonthKeys() { return isAllTime() ? Object.keys(REVENUE_DATA).sort() : [currentMonth]; }

function getMonthDays(mk) {
  const [y,m] = mk.split('-').map(Number);
  return new Date(y, m, 0).getDate();
}

function getRevForMonth(mk) { return REVENUE_DATA[mk] || null; }
function getPurchForMonth(mk) { return PURCHASE_DATA[mk] || null; }

function getMonthlyRevenue(plug, mk) {
  const d = getRevForMonth(mk);
  if (!d) return 0;
  return sum(d.revenue[plug] || []);
}
function getMonthlySubs(plug, mk) {
  const d = getRevForMonth(mk);
  if (!d) return 0;
  return sum(d.subscriptions[plug] || []);
}
function getMonthlyPurchases(plug, mk) {
  const d = getPurchForMonth(mk);
  if (!d) return 0;
  return sum(d.purchases[plug] || []);
}

function getCampaignKey(mk) { return `powerplugs-plans-${mk || currentMonth}`; }

// Load campaigns: localStorage (sync, immediate), Sheets (async, background)
function loadCampaigns(mk) {
  try { return JSON.parse(localStorage.getItem(getCampaignKey(mk))) || {}; } catch { return {}; }
}

// Save campaigns: localStorage immediately + Sheets in background
function saveCampaigns(c, mk) {
  const key = getCampaignKey(mk);
  localStorage.setItem(key, JSON.stringify(c));
  // Async save to Sheets (non-blocking)
  saveCampaignsToSheets(c, mk || currentMonth);
}

// Flatten campaigns object to rows for Sheets
async function saveCampaignsToSheets(campaigns, month) {
  if (!SheetsAPI.enabled) return;
  const headers = ['id','name','powerplug','subType','startDate','endDate','expectedRevenue','actualRevenue','status','notes','month'];
  const rows = [];
  for (const [pp, items] of Object.entries(campaigns)) {
    for (const item of (items || [])) {
      rows.push(headers.map(h => {
        if (h === 'month') return month;
        if (h === 'powerplug') return item.powerplug || pp;
        return item[h] !== undefined ? item[h] : '';
      }));
    }
  }
  await SheetsAPI.write('MonthlyPlan', rows, headers);
}

// Load campaigns from Sheets and merge into localStorage (called once at init)
async function syncCampaignsFromSheets() {
  const data = await SheetsAPI.read('MonthlyPlan');
  if (!data || data.length === 0) return;
  // Group by month
  const byMonth = {};
  for (const row of data) {
    const month = row.month || currentMonth;
    if (!byMonth[month]) byMonth[month] = {};
    const pp = row.powerplug || 'General';
    if (!byMonth[month][pp]) byMonth[month][pp] = [];
    byMonth[month][pp].push({
      id: row.id || uuid(),
      name: row.name || '',
      powerplug: pp,
      subType: row.subType || 'Other',
      startDate: row.startDate || '',
      endDate: row.endDate || '',
      expectedRevenue: Number(row.expectedRevenue) || 0,
      actualRevenue: Number(row.actualRevenue) || 0,
      status: row.status || 'Planned',
      notes: row.notes || '',
    });
  }
  // Merge into localStorage (Sheets data wins)
  for (const [month, campaigns] of Object.entries(byMonth)) {
    localStorage.setItem(`powerplugs-plans-${month}`, JSON.stringify(campaigns));
  }
}
function getCampaignTarget(mk) {
  const c = loadCampaigns(mk || currentMonth);
  const keys = currentPP === 'All' ? [...PLUGS, 'General'] : [currentPP, 'General'];
  let t = 0;
  keys.forEach(k => (c[k]||[]).forEach(x => t += (Number(x.expectedRevenue)||0)));
  return t;
}
function uuid() { return Math.random().toString(36).substr(2,8); }
function escHtml(s) { return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function getBadgeClass(p) { if (p==='CnO Pro') return 'badge-CnO'; if (p==='CnO Plus') return 'badge-CnOPlus'; if (p==='General') return 'badge-General'; return 'badge-'+p; }

function ppOptions(selected, includeGeneral) {
  let opts = '<option value="General"' + (selected==='General'?' selected':'') + '>General</option>';
  PLUGS.forEach(p => { opts += '<option value="'+p+'"' + (selected===p?' selected':'') + '>' + displayName(p) + '</option>'; });
  return opts;
}
const SUB_TYPES = ['Emails', 'UI Nudges', 'Social Media', 'Other'];
function subTypeOptions(selected) {
  return SUB_TYPES.map(s => '<option value="'+s+'"' + (selected===s?' selected':'') + '>' + s + '</option>').join('');
}

// ============================================================
// KPIs
// ============================================================
function renderKPIs() {
  const strip = document.getElementById('kpiStrip');
  const plugs = getPlugs();
  const months = getMonthKeys();
  let totalRev=0, totalPurch=0;
  months.forEach(mk => plugs.forEach(p => {
    totalRev += getMonthlyRevenue(p, mk);
    totalPurch += getMonthlyPurchases(p, mk);
  }));

  let projectedRev = '\u2014', targetVal = '\u2014';
  if (!isAllTime()) {
    const mk = currentMonth;
    const d = getRevForMonth(mk);
    const daysElapsed = d ? d.dates.length : 1;
    const daysInMonth = getMonthDays(mk);
    projectedRev = '$' + Math.round((totalRev / daysElapsed) * daysInMonth).toLocaleString();
    const ct = getCampaignTarget(mk);
    targetVal = ct > 0 ? '$' + ct.toLocaleString() : 'Not Set';
  }

  const kpis = [
    { label: isAllTime() ? 'Total Revenue' : 'Revenue (MTD)', value: '$' + Math.round(totalRev).toLocaleString() },
    { label: 'Projected Monthly', value: projectedRev },
    { label: 'Plan Target', value: targetVal },
    { label: 'Total Purchases', value: totalPurch.toLocaleString() },
    { label: 'Avg Daily Rev', value: '$' + Math.round(totalRev / (isAllTime() ? Object.values(REVENUE_DATA).reduce((s,d) => s+d.dates.length, 0) : (getRevForMonth(currentMonth)?.dates.length || 1))).toLocaleString() },
  ];
  strip.innerHTML = kpis.map(k => `<div class="kpi-card"><div class="label">${k.label}</div><div class="value">${k.value}</div></div>`).join('');
}

// ============================================================
// USER STATS (placeholder data - needs Snowflake connection for real numbers)
// ============================================================
// User data (injected by refresh_dashboard.py)
const USER_DATA = {"AFib":{"users":3275,"paid":1720,"male":50,"female":45},"Cardio":{"users":8499,"paid":5699,"male":41,"female":54},"CnO Pro":{"users":22543,"paid":16530,"male":0,"female":97},"Respiratory":{"users":16202,"paid":7961,"male":38,"female":57},"Tesla":{"users":147,"paid":77,"male":56,"female":34},"_total":{"users":0,"male":22,"female":73}};

function renderUserStats() {
  const container = document.getElementById('userStatsGrid');
  const plugs = getPlugs();
  let html = '';

  plugs.forEach(p => {
    const ud = USER_DATA[p] || { users: 0, paid: 0, male: 50, female: 50 };
    const onTrial = ud.users - (ud.paid || 0);
    html += `<div class="user-stat-card">
      <div class="stat-label">${displayName(p)}</div>
      <div class="stat-value">${ud.users.toLocaleString()}</div>
      <div class="stat-sub">total users &middot; <span style="color:#4ade80">${(ud.paid||0).toLocaleString()} paid</span>${onTrial > 0 ? ' &middot; <span style="color:#7c5cfc">'+onTrial.toLocaleString()+' trial</span>' : ''}</div>
      <div class="gender-bar"><div class="male" style="width:${ud.male}%"></div><div class="female" style="width:${ud.female}%"></div></div>
      <div class="gender-labels"><span class="m">\u2642 ${ud.male}%</span><span class="f">\u2640 ${ud.female}%</span></div>
    </div>`;
  });

  // If showing all, show total (deduplicated â€” not a simple sum since users may use multiple PPs)
  if (plugs.length > 1) {
    const total = USER_DATA['_total'] || { users: 0, male: 50, female: 50 };
    const sumUsers = PLUGS.reduce((s,p) => s + (USER_DATA[p]?.users||0), 0);
    const sumPaid = PLUGS.reduce((s,p) => s + (USER_DATA[p]?.paid||0), 0);
    const displayTotal = total.users > 0 ? total.users : sumUsers;
    const totalLabel = total.users > 0 ? 'deduplicated across PPs' : 'sum across PPs (may overlap)';
    html = `<div class="user-stat-card">
      <div class="stat-label">Total Users</div>
      <div class="stat-value">${displayTotal.toLocaleString()}</div>
      <div class="stat-sub">${totalLabel} &middot; <span style="color:#4ade80">${sumPaid.toLocaleString()} paid</span></div>
      <div class="gender-bar"><div class="male" style="width:${total.male}%"></div><div class="female" style="width:${total.female}%"></div></div>
      <div class="gender-labels"><span class="m">\u2642 ${total.male}%</span><span class="f">\u2640 ${total.female}%</span></div>
    </div>` + html;
  }

  container.innerHTML = html;
}

// ============================================================
// COUNTRY REVENUE BREAKDOWN TABLE
// ============================================================
let currentCountry = 'All';

function renderCountryRevenue() {
  const container = document.getElementById('countryRevenueTable');
  if (!container) return;

  const plugs = getPlugs();
  const allMonths = Object.keys(COUNTRY_REVENUE_DATA).sort();
  const countryFilter = currentCountry;
  const countryName = countryFilter !== 'All' ? countryCodeToName(countryFilter) : null;

  // If a specific country is selected, show monthly breakdown for that country
  if (countryName) {
    return renderSingleCountryRevenue(container, plugs, allMonths, countryName);
  }

  // "All Countries" view: show ranked table for selected month(s)
  const months = getMonthKeys();

  // Aggregate country revenue across selected months
  const countryTotals = {};
  const grandTotal = {};
  plugs.forEach(p => grandTotal[p] = 0);

  months.forEach(mk => {
    const mdata = COUNTRY_REVENUE_DATA[mk];
    if (!mdata) return;
    for (const [country, ppData] of Object.entries(mdata)) {
      if (country === '_total') continue;
      if (!countryTotals[country]) {
        countryTotals[country] = {};
        plugs.forEach(p => countryTotals[country][p] = 0);
      }
      plugs.forEach(p => {
        const val = ppData[p] || 0;
        countryTotals[country][p] += val;
        grandTotal[p] += val;
      });
    }
  });

  const sortedCountries = Object.keys(countryTotals).sort((a, b) => {
    return plugs.reduce((s, p) => s + countryTotals[b][p], 0) - plugs.reduce((s, p) => s + countryTotals[a][p], 0);
  });

  const overallTotal = plugs.reduce((s, p) => s + grandTotal[p], 0);

  let html = '<table class="projection-table"><thead><tr><th>Country</th>';
  plugs.forEach(p => html += `<th>${displayName(p)}</th>`);
  html += '<th>Total</th><th>Share</th></tr></thead><tbody>';

  sortedCountries.forEach(country => {
    const ct = countryTotals[country];
    const rowTotal = plugs.reduce((s, p) => s + ct[p], 0);
    const share = overallTotal > 0 ? ((rowTotal / overallTotal) * 100).toFixed(1) : '0.0';
    html += `<tr><td style="font-weight:600;color:#ccc">${country}</td>`;
    plugs.forEach(p => html += `<td>$${Math.round(ct[p]).toLocaleString()}</td>`);
    html += `<td style="font-weight:700">$${Math.round(rowTotal).toLocaleString()}</td>`;
    html += `<td style="color:#7c5cfc">${share}%</td></tr>`;
  });

  // Grand total row
  if (sortedCountries.length > 1) {
    html += '<tr style="font-weight:700;border-top:2px solid #7c5cfc"><td>Total</td>';
    plugs.forEach(p => html += `<td>$${Math.round(grandTotal[p]).toLocaleString()}</td>`);
    html += `<td>$${Math.round(overallTotal).toLocaleString()}</td><td style="color:#7c5cfc">100%</td></tr>`;
  }

  html += '</tbody></table>';
  container.innerHTML = html;
}

function renderSingleCountryRevenue(container, plugs, allMonths, countryName) {
  // Monthly breakdown for one country + comparison to global
  let html = `<div style="margin-bottom:16px;font-size:15px;font-weight:600;color:#7c5cfc">${countryName} â€” Monthly Revenue</div>`;

  // Monthly table: rows = months, columns = PPs + total
  html += '<table class="projection-table"><thead><tr><th>Month</th>';
  plugs.forEach(p => html += `<th>${displayName(p)}</th>`);
  html += '<th>Total</th><th>% of Global</th></tr></thead><tbody>';

  let grandPP = {}; plugs.forEach(p => grandPP[p] = 0);
  let grandTotal = 0, grandGlobal = 0;

  allMonths.forEach(mk => {
    const mdata = COUNTRY_REVENUE_DATA[mk];
    if (!mdata) return;
    const cdata = mdata[countryName] || {};
    const globalData = mdata['_total'] || {};
    const label = new Date(mk + '-01').toLocaleString('default', { month: 'short', year: 'numeric' });
    let rowTotal = 0;
    const globalTotal = plugs.reduce((s, p) => s + (globalData[p] || 0), 0);

    html += `<tr><td>${label}</td>`;
    plugs.forEach(p => {
      const val = Math.round(cdata[p] || 0);
      rowTotal += val;
      grandPP[p] += val;
      html += `<td>$${val.toLocaleString()}</td>`;
    });
    grandTotal += rowTotal;
    grandGlobal += globalTotal;
    const pctGlobal = globalTotal > 0 ? ((rowTotal / globalTotal) * 100).toFixed(1) : '0.0';
    html += `<td style="font-weight:700">$${rowTotal.toLocaleString()}</td>`;
    html += `<td style="color:#7c5cfc">${pctGlobal}%</td></tr>`;
  });

  // Total row
  html += '<tr style="font-weight:700;border-top:2px solid #7c5cfc"><td>Total</td>';
  plugs.forEach(p => html += `<td>$${Math.round(grandPP[p]).toLocaleString()}</td>`);
  const overallPct = grandGlobal > 0 ? ((grandTotal / grandGlobal) * 100).toFixed(1) : '0.0';
  html += `<td>$${Math.round(grandTotal).toLocaleString()}</td>`;
  html += `<td style="color:#7c5cfc">${overallPct}%</td></tr>`;
  html += '</tbody></table>';

  // PP share breakdown for this country
  html += `<div style="margin-top:20px;display:flex;gap:12px;flex-wrap:wrap">`;
  plugs.forEach(p => {
    const val = Math.round(grandPP[p]);
    const pct = grandTotal > 0 ? ((val / grandTotal) * 100).toFixed(0) : 0;
    const color = COLORS[p]?.border || '#888';
    html += `<div style="background:rgba(255,255,255,0.03);border:1px solid ${color}33;border-radius:10px;padding:12px 18px;min-width:130px;text-align:center">
      <div style="font-size:11px;text-transform:uppercase;letter-spacing:0.8px;color:#888;margin-bottom:4px">${displayName(p)}</div>
      <div style="font-size:20px;font-weight:700;color:${color}">$${val.toLocaleString()}</div>
      <div style="font-size:12px;color:#666;margin-top:2px">${pct}% of country total</div>
    </div>`;
  });
  html += '</div>';

  container.innerHTML = html;
}

// Map country code from filter dropdown to display name
function countryCodeToName(code) {
  const map = {
    'US': 'USA', 'IN': 'India', 'CA': 'Canada', 'GB': 'UK + IR',
    'AU': 'Australia', 'DE': 'Germany', 'AE': 'UAE', 'CZ': 'Czech Republic',
    'TH': 'Thailand', 'CH': 'Switzerland', 'ES': 'Spain', 'NL': 'Netherlands',
    'SG': 'Singapore', 'PH': 'Philippines',
  };
  return map[code] || code;
}

// ============================================================
// REVENUE CHART
// ============================================================
function renderRevenueChart() {
  if (charts.revenue) charts.revenue.destroy();
  const ctx = document.getElementById('revenueChart').getContext('2d');
  const plugs = getPlugs();

  if (isAllTime()) {
    const months = Object.keys(REVENUE_DATA).sort();
    const labels = months.map(m => { const d = new Date(m+'-01'); return d.toLocaleString('default',{month:'short',year:'2-digit'}); });
    const datasets = [];
    if (currentPP === 'All') {
      const totalData = months.map(mk => Math.round(plugs.reduce((s,p) => s + getMonthlyRevenue(p,mk), 0)));
      datasets.push({ label: 'Total', data: totalData, borderColor: '#7c5cfc', backgroundColor: 'rgba(124,92,252,0.08)', borderWidth: 2.5, tension: 0.3, fill: true, pointRadius: 4 });
      PLUGS.forEach(p => {
        datasets.push({ label: displayName(p), data: months.map(mk => Math.round(getMonthlyRevenue(p,mk))), borderColor: COLORS[p].border, borderWidth: 1.5, tension: 0.3, fill: false, pointRadius: 3 });
      });
    } else {
      const data = months.map(mk => Math.round(getMonthlyRevenue(currentPP,mk)));
      datasets.push({ label: displayName(currentPP), data, borderColor: COLORS[currentPP].border, backgroundColor: COLORS[currentPP].fill, borderWidth: 2.5, tension: 0.3, fill: true, pointRadius: 4 });
    }
    charts.revenue = new Chart(ctx, { type: 'line', data: { labels, datasets }, options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { position: 'top', labels: { usePointStyle: true, padding: 16, font: { size: 11 } } }, tooltip: { callbacks: { label: c => c.parsed.y != null ? `${c.dataset.label}: $${c.parsed.y.toLocaleString()}` : '' } } }, scales: { y: { beginAtZero: true, ticks: { callback: v => '$'+v.toLocaleString() } } } } });
    return;
  }

  const mk = currentMonth;
  const revData = getRevForMonth(mk);
  if (!revData) { charts.revenue = new Chart(ctx, { type: 'line', data: { labels: [], datasets: [] } }); return; }

  const actualDates = revData.dates;
  const actualDays = actualDates.length;
  const daysInMonth = getMonthDays(mk);
  const allDates = [];
  const [y,m] = mk.split('-').map(Number);
  for (let d=1; d<=daysInMonth; d++) allDates.push(`${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`);

  const actualValues = [];
  for (let i=0; i<actualDays; i++) { let s=0; plugs.forEach(p => s += (revData.revenue[p]?.[i]||0)); actualValues.push(Math.round(s)); }
  const dailyAvg = sum(actualValues) / actualDays;

  const actualLine = [], projectedLine = [];
  for (let i=0; i<daysInMonth; i++) {
    if (i < actualDays) { actualLine.push(actualValues[i]); projectedLine.push(null); }
    else if (i === actualDays) { actualLine.push(null); projectedLine.push(actualValues[actualDays-1]); }
    else { actualLine.push(null); projectedLine.push(Math.round(dailyAvg)); }
  }

  const datasets = [
    { label: 'Actual Revenue', data: actualLine, borderColor: '#7c5cfc', backgroundColor: 'rgba(124,92,252,0.08)', borderWidth: 2.5, tension: 0.3, fill: true, pointRadius: 2, spanGaps: false },
    { label: 'Projected', data: projectedLine, borderColor: '#7c5cfc', borderWidth: 2, borderDash: [6,4], tension: 0.1, fill: false, pointRadius: 0, spanGaps: true },
  ];

  const ct = getCampaignTarget(mk);
  if (ct > 0) {
    const dailyTarget = Math.round(ct / daysInMonth);
    datasets.push({ label: 'Plan Target', data: allDates.map(() => dailyTarget), borderColor: '#f59e0b', borderWidth: 2, borderDash: [10,5], tension: 0, fill: false, pointRadius: 0 });
  }

  if (currentPP === 'All') {
    PLUGS.forEach(p => {
      const vals = revData.revenue[p] || [];
      const ld = allDates.map((_,i) => i < actualDays ? Math.round(vals[i]||0) : null);
      datasets.push({ label: displayName(p), data: ld, borderColor: COLORS[p].border, borderWidth: 1.5, tension: 0.3, fill: false, pointRadius: 1, spanGaps: false });
    });
  }

  charts.revenue = new Chart(ctx, { type: 'line', data: { labels: allDates.map(d => d.slice(5)), datasets }, options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => c.parsed.y != null ? `${c.dataset.label}: $${c.parsed.y.toLocaleString()}` : '' } } }, scales: { y: { beginAtZero: true, ticks: { callback: v => '$'+v.toLocaleString() } } } } });
}

// ============================================================
// TRIAL vs CONVERTED
// ============================================================
const DATALABEL_OPTS = { display: true, anchor: 'end', align: 'end', color: '#ccc', font: { size: 11, weight: '600' }, formatter: v => v > 0 ? v.toLocaleString() : '' };

function renderTrialChart() {
  if (charts.trial) charts.trial.destroy();
  const ctx = document.getElementById('trialChart').getContext('2d');
  const plugs = getPlugs();

  // Use real TRIAL_DATA when available, fall back to subscriptions/purchases proxy
  function getTrialVal(p, mk) { return hasRealTrialData(p) ? getMonthlyTrials(p, mk) : getMonthlySubs(p, mk); }
  function getConvVal(p, mk) { return hasRealTrialData(p) ? getMonthlyConverted(p, mk) : getMonthlyPurchases(p, mk); }

  if (isAllTime()) {
    const months = Object.keys(REVENUE_DATA).sort();
    const labels = months.map(m => { const d = new Date(m+'-01'); return d.toLocaleString('default',{month:'short',year:'2-digit'}); });
    const trialData = months.map(mk => plugs.reduce((s,p) => s + getTrialVal(p,mk), 0));
    const convData = months.map(mk => plugs.reduce((s,p) => s + getConvVal(p,mk), 0));
    charts.trial = new Chart(ctx, { type: 'bar', data: { labels, datasets: [
      { label: 'Trial Users', data: trialData, backgroundColor: 'rgba(124,92,252,0.35)', borderColor: '#7c5cfc', borderWidth: 1, borderRadius: 4, datalabels: DATALABEL_OPTS },
      { label: 'Converted (Paid)', data: convData, backgroundColor: 'rgba(74,222,128,0.35)', borderColor: '#4ade80', borderWidth: 1, borderRadius: 4, datalabels: {...DATALABEL_OPTS, color: '#4ade80'} },
    ] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { usePointStyle: true, padding: 16, font: { size: 11 } } } }, scales: { y: { beginAtZero: true } } } });
    return;
  }

  const labels = plugs.map(displayName);
  const trialValues = plugs.map(p => getTrialVal(p, currentMonth));
  const convValues = plugs.map(p => getConvVal(p, currentMonth));
  charts.trial = new Chart(ctx, { type: 'bar', data: { labels, datasets: [
    { label: 'Trial Users', data: trialValues, backgroundColor: 'rgba(124,92,252,0.35)', borderColor: '#7c5cfc', borderWidth: 1, borderRadius: 6, datalabels: DATALABEL_OPTS },
    { label: 'Converted (Paid)', data: convValues, backgroundColor: 'rgba(74,222,128,0.35)', borderColor: '#4ade80', borderWidth: 1, borderRadius: 6, datalabels: {...DATALABEL_OPTS, color: '#4ade80'} },
  ] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { usePointStyle: true, padding: 16, font: { size: 11 } } } }, scales: { y: { beginAtZero: true } } } });
}

// ============================================================
// CONVERSION RATE
// ============================================================
function renderConversionChart() {
  if (charts.conversion) charts.conversion.destroy();
  const ctx = document.getElementById('conversionChart').getContext('2d');
  const plugs = getPlugs();
  const months = getMonthKeys();

  const rates = plugs.map(p => {
    let trial = 0, conv = 0;
    months.forEach(mk => {
      trial += hasRealTrialData(p) ? getMonthlyTrials(p,mk) : getMonthlySubs(p,mk);
      conv += hasRealTrialData(p) ? getMonthlyConverted(p,mk) : getMonthlyPurchases(p,mk);
    });
    return trial > 0 ? ((conv / trial) * 100).toFixed(1) : 0;
  });

  charts.conversion = new Chart(ctx, { type: 'bar', data: { labels: plugs.map(displayName), datasets: [{ label: 'Conversion %', data: rates, backgroundColor: plugs.map(p => (COLORS[p]?.border || '#888') + '66'), borderColor: plugs.map(p => COLORS[p]?.border || '#888'), borderWidth: 1, borderRadius: 6 }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => c.parsed.x + '%' } } }, scales: { x: { beginAtZero: true, ticks: { callback: v => v + '%' } } } } });
}

// ============================================================
// PURCHASE CHART
// ============================================================
function renderPurchaseChart() {
  if (charts.purchase) charts.purchase.destroy();
  const ctx = document.getElementById('purchaseChart').getContext('2d');
  const plugs = getPlugs();

  if (isAllTime()) {
    const months = Object.keys(PURCHASE_DATA).sort();
    const labels = months.map(m => { const d = new Date(m+'-01'); return d.toLocaleString('default',{month:'short',year:'2-digit'}); });
    const datasets = plugs.map(p => ({ label: displayName(p), data: months.map(mk => getMonthlyPurchases(p,mk)), backgroundColor: COLORS[p].border, borderRadius: 3 }));
    charts.purchase = new Chart(ctx, { type: 'bar', data: { labels, datasets }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { usePointStyle: true, padding: 16, font: { size: 11 } } } }, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } } });
    return;
  }

  const pd = getPurchForMonth(currentMonth);
  if (!pd) { charts.purchase = new Chart(ctx, { type: 'bar', data: { labels: [], datasets: [] } }); return; }
  const datasets = plugs.map(p => ({ label: displayName(p), data: pd.purchases[p]||[], backgroundColor: COLORS[p].border, borderRadius: 3 }));
  charts.purchase = new Chart(ctx, { type: 'bar', data: { labels: pd.dates.map(d => d.slice(5)), datasets }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { usePointStyle: true, padding: 16, font: { size: 11 } } } }, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } } });
}

// ============================================================
// POWERPLUG LEGEND (below revenue chart)
// ============================================================
function renderPPLegend() {
  const container = document.getElementById('ppLegend');
  const plugs = currentPP === 'All' ? PLUGS : [currentPP];
  let html = '';
  plugs.forEach(p => {
    html += `<div class="pp-legend-item"><div class="pp-legend-dot" style="background:${COLORS[p].border}"></div>${displayName(p)}</div>`;
  });
  // Always show the meta lines
  html += `<div class="pp-legend-item"><div style="width:24px;height:0;border-top:2.5px solid #7c5cfc;"></div>Total/Actual</div>`;
  html += `<div class="pp-legend-item"><div style="width:24px;height:0;border-top:2.5px dotted #7c5cfc;"></div>Projected</div>`;
  html += `<div class="pp-legend-item"><div style="width:24px;height:0;border-top:2.5px dashed #f59e0b;"></div>Plan Target</div>`;
  container.innerHTML = html;
}

// ============================================================
// INSIGHTS & TRENDS
// ============================================================
function renderInsights() {
  const container = document.getElementById('insightsSection');
  const plugs = getPlugs();
  const months = getMonthKeys();

  if (isAllTime()) {
    // MoM trend analysis
    const allMonths = Object.keys(REVENUE_DATA).sort();
    const revByMonth = allMonths.map(mk => plugs.reduce((s,p) => s + getMonthlyRevenue(p,mk), 0));
    const purchByMonth = allMonths.map(mk => plugs.reduce((s,p) => s + getMonthlyPurchases(p,mk), 0));
    const subsByMonth = allMonths.map(mk => plugs.reduce((s,p) => s + getMonthlySubs(p,mk), 0));

    // Revenue trend
    let revInsights = '';
    for (let i = 1; i < allMonths.length; i++) {
      const prev = revByMonth[i-1], curr = revByMonth[i];
      const pct = prev > 0 ? (((curr - prev) / prev) * 100).toFixed(1) : 0;
      const cls = pct > 0 ? 'up' : pct < 0 ? 'down' : 'neutral';
      const arrow = pct > 0 ? '\u25B2' : pct < 0 ? '\u25BC' : '\u25C6';
      const mLabel = new Date(allMonths[i]+'-01').toLocaleString('default',{month:'short'});
      revInsights += `<div class="insight-item">${mLabel}: <span class="val">$${Math.round(curr).toLocaleString()}</span> <span class="${cls}">${arrow} ${Math.abs(pct)}% MoM</span></div>`;
    }

    // Best/worst performing PP
    let ppInsights = '';
    const ppTotals = PLUGS.map(p => ({ name: displayName(p), rev: allMonths.reduce((s,mk) => s + getMonthlyRevenue(p,mk), 0) }));
    ppTotals.sort((a,b) => b.rev - a.rev);
    ppInsights += `<div class="insight-item">Top revenue: <span class="val">${ppTotals[0].name}</span> ($${Math.round(ppTotals[0].rev).toLocaleString()})</div>`;
    if (ppTotals.length > 1) {
      const last = ppTotals[ppTotals.length-1];
      ppInsights += `<div class="insight-item">Lowest: <span class="val">${last.name}</span> ($${Math.round(last.rev).toLocaleString()})</div>`;
    }
    // Latest month vs first month growth
    const firstRev = revByMonth[0], lastRev = revByMonth[revByMonth.length-1];
    const totalGrowth = firstRev > 0 ? (((lastRev - firstRev) / firstRev) * 100).toFixed(0) : 0;
    ppInsights += `<div class="insight-item">Period growth: <span class="${totalGrowth > 0?'up':'down'}">${totalGrowth > 0?'+':''}${totalGrowth}%</span> (${new Date(allMonths[0]+'-01').toLocaleString('default',{month:'short'})} \u2192 ${new Date(allMonths[allMonths.length-1]+'-01').toLocaleString('default',{month:'short'})})</div>`;

    // Purchase volume trend
    let purchInsights = '';
    const totalPurch = sum(purchByMonth);
    const avgMonthlyPurch = Math.round(totalPurch / allMonths.length);
    purchInsights += `<div class="insight-item">Avg monthly purchases: <span class="val">${avgMonthlyPurch.toLocaleString()}</span></div>`;
    const lastPurch = purchByMonth[purchByMonth.length-1], prevPurch = purchByMonth[purchByMonth.length-2] || 0;
    if (prevPurch > 0) {
      const pPct = (((lastPurch - prevPurch) / prevPurch) * 100).toFixed(1);
      purchInsights += `<div class="insight-item">Latest month: <span class="${pPct > 0?'up':'down'}">${pPct > 0?'+':''}${pPct}% vs prior</span></div>`;
    }
    const totalSubs = sum(subsByMonth);
    const convRate = totalSubs > 0 ? ((totalPurch / totalSubs) * 100).toFixed(1) : 0;
    purchInsights += `<div class="insight-item">Overall conversion: <span class="val">${convRate}%</span></div>`;

    // Subscription trend
    let subInsights = '';
    const avgSubs = Math.round(sum(subsByMonth) / allMonths.length);
    subInsights += `<div class="insight-item">Avg monthly subs: <span class="val">${avgSubs.toLocaleString()}</span></div>`;
    const lastSubs = subsByMonth[subsByMonth.length-1], prevSubs = subsByMonth[subsByMonth.length-2] || 0;
    if (prevSubs > 0) {
      const sPct = (((lastSubs - prevSubs) / prevSubs) * 100).toFixed(1);
      subInsights += `<div class="insight-item">Latest month: <span class="${sPct > 0?'up':'down'}">${sPct > 0?'+':''}${sPct}% vs prior</span></div>`;
    }

    container.innerHTML = `
      <div class="insight-card"><h3>\u{1F4C8} Revenue MoM</h3>${revInsights}</div>
      <div class="insight-card"><h3>\u{1F3AF} Powerplug Performance</h3>${ppInsights}</div>
      <div class="insight-card"><h3>\u{1F6D2} Purchase Trends</h3>${purchInsights}</div>
      <div class="insight-card"><h3>\u{1F504} Subscription Trends</h3>${subInsights}</div>`;
    return;
  }

  // MONTHLY VIEW INSIGHTS
  const mk = currentMonth;
  const revData = getRevForMonth(mk);
  const purchData = getPurchForMonth(mk);
  if (!revData) { container.innerHTML = '<div class="insight-item">No data available for this month.</div>'; return; }

  const daysElapsed = revData.dates.length;
  const daysInMonth = getMonthDays(mk);
  const totalRev = plugs.reduce((s,p) => s + getMonthlyRevenue(p,mk), 0);
  const totalPurch = plugs.reduce((s,p) => s + getMonthlyPurchases(p,mk), 0);
  const totalSubs = plugs.reduce((s,p) => s + getMonthlySubs(p,mk), 0);
  const projectedRev = Math.round((totalRev / daysElapsed) * daysInMonth);
  const dailyAvg = Math.round(totalRev / daysElapsed);

  // Revenue insights
  let revHtml = '';
  revHtml += `<div class="insight-item">MTD: <span class="val">$${Math.round(totalRev).toLocaleString()}</span> in ${daysElapsed} days</div>`;
  revHtml += `<div class="insight-item">Daily avg: <span class="val">$${dailyAvg.toLocaleString()}</span></div>`;
  revHtml += `<div class="insight-item">Run-rate projection: <span class="val">$${projectedRev.toLocaleString()}</span></div>`;
  const planTarget = getCampaignTarget(mk);
  if (planTarget > 0) {
    const pctOfTarget = ((totalRev / planTarget) * 100).toFixed(0);
    const onPace = (projectedRev / planTarget * 100).toFixed(0);
    revHtml += `<div class="insight-item">vs Plan Target: <span class="${Number(onPace)>=100?'up':'down'}">${onPace}% on pace</span> (${pctOfTarget}% achieved)</div>`;
  }

  // Compare to previous month
  const allMonths = Object.keys(REVENUE_DATA).sort();
  const mkIdx = allMonths.indexOf(mk);
  let momHtml = '';
  if (mkIdx > 0) {
    const prevMk = allMonths[mkIdx-1];
    const prevRev = plugs.reduce((s,p) => s + getMonthlyRevenue(p,prevMk), 0);
    const prevPurch = plugs.reduce((s,p) => s + getMonthlyPurchases(p,prevMk), 0);
    const prevSubs = plugs.reduce((s,p) => s + getMonthlySubs(p,prevMk), 0);
    const prevLabel = new Date(prevMk+'-01').toLocaleString('default',{month:'short',year:'numeric'});

    const revPct = prevRev > 0 ? (((projectedRev - prevRev) / prevRev) * 100).toFixed(1) : 0;
    momHtml += `<div class="insight-item">Revenue vs ${prevLabel}: <span class="${revPct > 0?'up':'down'}">${revPct > 0?'+':''}${revPct}%</span> (projected)</div>`;

    if (prevPurch > 0) {
      const projPurch = Math.round((totalPurch / daysElapsed) * daysInMonth);
      const purchPct = (((projPurch - prevPurch) / prevPurch) * 100).toFixed(1);
      momHtml += `<div class="insight-item">Purchases vs ${prevLabel}: <span class="${purchPct > 0?'up':'down'}">${purchPct > 0?'+':''}${purchPct}%</span> (projected)</div>`;
    }
    if (prevSubs > 0) {
      const projSubs = Math.round((totalSubs / daysElapsed) * daysInMonth);
      const subsPct = (((projSubs - prevSubs) / prevSubs) * 100).toFixed(1);
      momHtml += `<div class="insight-item">Subs vs ${prevLabel}: <span class="${subsPct > 0?'up':'down'}">${subsPct > 0?'+':''}${subsPct}%</span> (projected)</div>`;
    }
  }

  // Per-PP breakdown
  let ppHtml = '';
  const ppData = plugs.map(p => {
    const trial = hasRealTrialData(p) ? getMonthlyTrials(p,mk) : getMonthlySubs(p,mk);
    const conv = hasRealTrialData(p) ? getMonthlyConverted(p,mk) : getMonthlyPurchases(p,mk);
    return { name: displayName(p), key: p, rev: getMonthlyRevenue(p,mk), trial, conv, hasReal: hasRealTrialData(p) };
  });
  ppData.sort((a,b) => b.rev - a.rev);
  ppData.forEach(pp => {
    const share = totalRev > 0 ? ((pp.rev / totalRev) * 100).toFixed(0) : 0;
    const convRate = pp.trial > 0 ? ((pp.conv / pp.trial) * 100).toFixed(0) : 0;
    const ppProj = Math.round((pp.rev / daysElapsed) * daysInMonth);
    const trialLabel = pp.hasReal ? `Trial: ${pp.trial} \u2192 Paid: ${pp.conv}` : `Subs: ${pp.trial} (proxy)`;
    ppHtml += `<div class="insight-item"><span class="val">${pp.name}</span>: $${Math.round(pp.rev).toLocaleString()} \u2192 <span style="color:#7c5cfc">$${ppProj.toLocaleString()} proj</span> (${share}%) &middot; ${trialLabel} (${convRate}%)</div>`;
  });

  // Trend within the month (first half vs second half)
  let trendHtml = '';
  if (daysElapsed >= 6) {
    const half = Math.floor(daysElapsed / 2);
    let firstHalfRev = 0, secondHalfRev = 0;
    plugs.forEach(p => {
      const vals = revData.revenue[p] || [];
      for (let i = 0; i < half; i++) firstHalfRev += (vals[i]||0);
      for (let i = half; i < daysElapsed; i++) secondHalfRev += (vals[i]||0);
    });
    const firstAvg = Math.round(firstHalfRev / half);
    const secondAvg = Math.round(secondHalfRev / (daysElapsed - half));
    const trendPct = firstAvg > 0 ? (((secondAvg - firstAvg) / firstAvg) * 100).toFixed(1) : 0;
    trendHtml += `<div class="insight-item">First ${half}d avg: <span class="val">$${firstAvg.toLocaleString()}/day</span></div>`;
    trendHtml += `<div class="insight-item">Last ${daysElapsed-half}d avg: <span class="val">$${secondAvg.toLocaleString()}/day</span> <span class="${trendPct > 0?'up':'down'}">${trendPct > 0?'+':''}${trendPct}%</span></div>`;
    trendHtml += `<div class="insight-item">Momentum: <span class="${trendPct > 5?'up':trendPct < -5?'down':'neutral'}">${trendPct > 5?'Accelerating':trendPct < -5?'Decelerating':'Steady'}</span></div>`;
  }

  container.innerHTML = `
    <div class="insight-card"><h3>\u{1F4B0} Revenue Snapshot</h3>${revHtml}</div>
    <div class="insight-card"><h3>\u{1F4CA} Month-over-Month</h3>${momHtml || '<div class="insight-item">No previous month data.</div>'}</div>
    <div class="insight-card"><h3>\u{1F3AF} Powerplug Breakdown</h3>${ppHtml}</div>
    <div class="insight-card"><h3>\u{1F4C8} Intra-Month Trend</h3>${trendHtml || '<div class="insight-item">Not enough data yet.</div>'}</div>`;
}

// ============================================================
// PROJECTION TABLE
// ============================================================
function renderProjectionTable() {
  const container = document.getElementById('projectionTable');
  const plugs = getPlugs();
  if (isAllTime()) {
    const months = Object.keys(REVENUE_DATA).sort();
    let html = '<table class="projection-table"><thead><tr><th>Month</th>';
    plugs.forEach(p => html += `<th>${displayName(p)}</th>`);
    html += '<th>Total</th></tr></thead><tbody>';
    months.forEach(mk => {
      const d = new Date(mk+'-01');
      const label = d.toLocaleString('default',{month:'short',year:'numeric'});
      let rowTotal = 0;
      html += `<tr><td>${label}</td>`;
      plugs.forEach(p => { const v = Math.round(getMonthlyRevenue(p,mk)); rowTotal += v; html += `<td>$${v.toLocaleString()}</td>`; });
      html += `<td style="font-weight:700">$${rowTotal.toLocaleString()}</td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
    return;
  }

  const mk = currentMonth;
  const revData = getRevForMonth(mk);
  if (!revData) { container.innerHTML = '<div class="no-campaigns">No data for this month</div>'; return; }
  const daysElapsed = revData.dates.length;
  const daysInMonth = getMonthDays(mk);
  const campaigns = loadCampaigns(mk);

  // Helper: get trial and paid counts for a PP in a month
  function getTrialCount(p, m) {
    if (hasRealTrialData(p)) {
      const td = getTrialDataForMonth(p, m);
      if (!td) return 0;
      // On trial = total trials - converted (those still on trial)
      return Math.max(0, sum(td.trial) - sum(td.converted));
    }
    // Proxy: subs - purchases as rough "on trial" estimate
    return Math.max(0, getMonthlySubs(p, m) - getMonthlyPurchases(p, m));
  }
  function getPaidCount(p, m) {
    if (hasRealTrialData(p)) {
      const td = getTrialDataForMonth(p, m);
      return td ? sum(td.converted) : 0;
    }
    return getMonthlyPurchases(p, m);
  }

  let rows = plugs.map(p => {
    const mtd = Math.round(getMonthlyRevenue(p,mk));
    const avg = Math.round(mtd/daysElapsed);
    const proj = Math.round(avg * daysInMonth);
    const purch = getMonthlyPurchases(p,mk);
    const pt = (campaigns[p]||[]).reduce((s,c) => s+(Number(c.expectedRevenue)||0), 0);
    const activeUsers = (USER_DATA[p]?.users || 0);
    const onTrial = getTrialCount(p, mk);
    const paidUsers = getPaidCount(p, mk);
    return `<tr><td><span class="plug-badge ${getBadgeClass(p)}">${displayName(p)}</span></td><td style="color:#aaa">${activeUsers > 0 ? activeUsers.toLocaleString() : '\u2014'}</td><td style="color:#7c5cfc">${onTrial.toLocaleString()}</td><td style="color:#4ade80">${paidUsers.toLocaleString()}</td><td>$${mtd.toLocaleString()}</td><td>$${avg.toLocaleString()}</td><td class="projected">$${proj.toLocaleString()}</td><td class="target-col">${pt>0?'$'+pt.toLocaleString():'\u2014'}</td><td>${purch.toLocaleString()}</td></tr>`;
  });

  if (plugs.length > 1) {
    let tMtd=0,tPurch=0,tTarget=0,tOnTrial=0,tPaid=0;
    plugs.forEach(p => { tMtd+=Math.round(getMonthlyRevenue(p,mk)); tPurch+=getMonthlyPurchases(p,mk); tTarget+=(campaigns[p]||[]).reduce((s,c)=>s+(Number(c.expectedRevenue)||0),0); tOnTrial+=getTrialCount(p,mk); tPaid+=getPaidCount(p,mk); });
    tTarget += (campaigns['General']||[]).reduce((s,c)=>s+(Number(c.expectedRevenue)||0),0);
    const tAvg=Math.round(tMtd/daysElapsed), tProj=Math.round(tAvg*daysInMonth);
    // Total active users: use dedicated total if available, else note it's not a simple sum
    const totalActiveUsers = USER_DATA._total?.users || null;
    const totalActiveStr = totalActiveUsers ? totalActiveUsers.toLocaleString() : '\u2014*';
    rows.push(`<tr style="font-weight:700;border-top:2px solid #7c5cfc"><td>Total</td><td style="color:#aaa">${totalActiveStr}</td><td style="color:#7c5cfc">${tOnTrial.toLocaleString()}</td><td style="color:#4ade80">${tPaid.toLocaleString()}</td><td>$${tMtd.toLocaleString()}</td><td>$${tAvg.toLocaleString()}</td><td class="projected">$${tProj.toLocaleString()}</td><td class="target-col">${tTarget>0?'$'+tTarget.toLocaleString():'\u2014'}</td><td>${tPurch.toLocaleString()}</td></tr>`);
  }

  container.innerHTML = `<table class="projection-table"><thead><tr><th>Powerplug</th><th>Active Users</th><th>On Trial</th><th>Paid Users</th><th>Revenue MTD</th><th>Daily Avg</th><th>Projected</th><th>Target</th><th>Purchases</th></tr></thead><tbody>${rows.join('')}</tbody></table>`;
}

// ============================================================
// MONTHLY PLAN TRACKER (enhanced with PP dropdown, dates, sub-type)
// ============================================================
function renderCampaignTracker() {
  const container = document.getElementById('campaignTracker');
  const progressContainer = document.getElementById('campaignProgress');
  if (isAllTime()) { container.innerHTML = '<div class="no-campaigns">Select a specific month to manage the monthly plan.</div>'; progressContainer.innerHTML = ''; return; }

  const campaigns = loadCampaigns(currentMonth);
  const categories = currentPP === 'All' ? ['General', ...PLUGS] : ['General', currentPP];

  let totalTarget=0, totalActual=0;
  categories.forEach(cat => (campaigns[cat]||[]).forEach(c => { totalTarget+=(Number(c.expectedRevenue)||0); totalActual+=(Number(c.actualRevenue)||0); }));

  const pct = totalTarget>0 ? Math.min(100, Math.round((totalActual/totalTarget)*100)) : 0;
  const barClass = pct>=70?'good':pct>=40?'warn':'bad';
  progressContainer.innerHTML = totalTarget>0 ? `<div class="progress-bar-container"><div class="progress-text"><strong>$${totalActual.toLocaleString()}</strong> / $${totalTarget.toLocaleString()} (${pct}%)</div><div class="progress-bar-track"><div class="progress-bar-fill ${barClass}" style="width:${pct}%"></div></div></div>` : '';

  const hasCampaigns = categories.some(cat => (campaigns[cat]||[]).length > 0);
  if (!hasCampaigns) { container.innerHTML = '<div class="no-campaigns">No plan items yet. Click "+ Add Initiative" to get started.</div>'; return; }

  let html = '<table class="campaign-table"><thead><tr><th>Powerplug</th><th>Type</th><th>Initiative</th><th>Start</th><th>End</th><th>Expected Rev</th><th>Actual Rev</th><th>Status</th><th>Notes</th><th></th></tr></thead><tbody>';
  categories.forEach(cat => {
    (campaigns[cat]||[]).forEach(c => {
      html += `<tr>
        <td><select onchange="moveCampaign('${cat}','${c.id}',this.value)">${ppOptions(cat, true)}</select></td>
        <td><select onchange="updateCampaign('${cat}','${c.id}','subType',this.value)">${subTypeOptions(c.subType||'Other')}</select></td>
        <td><input type="text" value="${escHtml(c.name)}" onchange="updateCampaign('${cat}','${c.id}','name',this.value)" placeholder="Initiative name" /></td>
        <td><input type="date" value="${c.startDate||''}" onchange="updateCampaign('${cat}','${c.id}','startDate',this.value)" /></td>
        <td><input type="date" value="${c.endDate||''}" onchange="updateCampaign('${cat}','${c.id}','endDate',this.value)" /></td>
        <td><input type="number" value="${c.expectedRevenue||''}" onchange="updateCampaign('${cat}','${c.id}','expectedRevenue',this.value)" placeholder="$0" /></td>
        <td><input type="number" value="${c.actualRevenue||''}" onchange="updateCampaign('${cat}','${c.id}','actualRevenue',this.value)" placeholder="$0" /></td>
        <td><select onchange="updateCampaign('${cat}','${c.id}','status',this.value)">
          <option value="On Track" ${c.status==='On Track'?'selected':''}>On Track</option>
          <option value="Delayed" ${c.status==='Delayed'?'selected':''}>Delayed</option>
          <option value="At Risk" ${c.status==='At Risk'?'selected':''}>At Risk</option>
          <option value="Completed" ${c.status==='Completed'?'selected':''}>Completed</option>
        </select></td>
        <td><input type="text" value="${escHtml(c.notes||'')}" onchange="updateCampaign('${cat}','${c.id}','notes',this.value)" placeholder="Notes..." /></td>
        <td><button class="btn btn-danger" onclick="deleteCampaign('${cat}','${c.id}')">Del</button></td></tr>`;
    });
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}

function addCampaign() {
  if (isAllTime()) return;
  const campaigns = loadCampaigns(currentMonth);
  const cat = currentPP === 'All' ? 'General' : currentPP;
  if (!campaigns[cat]) campaigns[cat] = [];
  campaigns[cat].push({ id: uuid(), name: '', subType: 'Other', startDate: '', endDate: '', expectedRevenue: 0, actualRevenue: 0, status: 'On Track', notes: '' });
  saveCampaigns(campaigns, currentMonth);
  renderAll();
}
function updateCampaign(cat, id, field, value) {
  const campaigns = loadCampaigns(currentMonth);
  const item = (campaigns[cat]||[]).find(c => c.id === id);
  if (item) { item[field] = field.includes('Revenue') ? Number(value)||0 : value; saveCampaigns(campaigns, currentMonth); renderAll(); }
}
function moveCampaign(oldCat, id, newCat) {
  if (oldCat === newCat) return;
  const campaigns = loadCampaigns(currentMonth);
  const idx = (campaigns[oldCat]||[]).findIndex(c => c.id === id);
  if (idx < 0) return;
  const item = campaigns[oldCat].splice(idx, 1)[0];
  if (!campaigns[oldCat].length) delete campaigns[oldCat];
  if (!campaigns[newCat]) campaigns[newCat] = [];
  campaigns[newCat].push(item);
  saveCampaigns(campaigns, currentMonth);
  renderAll();
}
function deleteCampaign(cat, id) {
  const campaigns = loadCampaigns(currentMonth);
  if (campaigns[cat]) { campaigns[cat] = campaigns[cat].filter(c => c.id !== id); if (!campaigns[cat].length) delete campaigns[cat]; saveCampaigns(campaigns, currentMonth); renderAll(); }
}

// ============================================================
// ACTIVE COUNTRIES TAB
// ============================================================
const COUNTRY_STORAGE_KEY = 'powerplugs-active-countries';

function getDefaultCountryData() {
  const data = {};
  // AFib Detection (powered by FibriCheck): Australia, EU, Singapore, UAE, UK, Saudi Arabia
  const afibCountries = ['Australia','Germany','UAE','UK + IR','Switzerland','Spain','Netherlands','Singapore','Czech Republic'];
  // Cardio Adaptability: USA, India, Canada
  const cardioCountries = ['USA','India','Canada'];
  // C&O Pro: US, UK, Australia, Canada + EU/European countries
  const cnoProCountries = ['USA','UK + IR','Australia','Canada','Germany','Czech Republic','Spain','Netherlands','Switzerland'];
  // C&O Plus: all other regions not in C&O Pro (India, UAE, Switzerland, Thailand, Philippines, Singapore, NZ, Mexico, Saudi Arabia, etc.)
  const cnoPlusCountries = ['India','UAE','Switzerland','Thailand','Singapore','Philippines'];
  // Respiratory, Tesla: placeholder
  COUNTRIES.forEach(country => {
    data[country] = {};
    data[country]['AFib'] = afibCountries.includes(country);
    data[country]['Cardio'] = cardioCountries.includes(country);
    data[country]['CnO Pro'] = cnoProCountries.includes(country);
    data[country]['CnO Plus'] = cnoPlusCountries.includes(country);
    data[country]['Respiratory'] = ['USA','India','Canada','UK + IR','Australia','Germany','UAE'].includes(country);
    data[country]['Tesla'] = true;
  });
  return data;
}

function loadCountryData() {
  try { const d = JSON.parse(localStorage.getItem(COUNTRY_STORAGE_KEY)); return d || getDefaultCountryData(); }
  catch { return getDefaultCountryData(); }
}
function saveCountryData(data) {
  localStorage.setItem(COUNTRY_STORAGE_KEY, JSON.stringify(data));
  // Async save to Sheets
  saveCountryDataToSheets(data);
}

async function saveCountryDataToSheets(data) {
  if (!SheetsAPI.enabled) return;
  const headers = ['country', 'AFib', 'Cardio', 'CnO Pro', 'Respiratory', 'Tesla'];
  const rows = [];
  for (const country of COUNTRIES) {
    rows.push(headers.map(h => {
      if (h === 'country') return country;
      return data[country]?.[h] ? '1' : '0';
    }));
  }
  await SheetsAPI.write('ActiveCountries', rows, headers);
}

async function syncCountryDataFromSheets() {
  const data = await SheetsAPI.read('ActiveCountries');
  if (!data || data.length === 0) return;
  const countryData = {};
  for (const row of data) {
    const country = row.country;
    if (!country) continue;
    countryData[country] = {};
    for (const pp of COUNTRY_PLUGS) {
      countryData[country][pp] = row[pp] === '1' || row[pp] === 'true' || row[pp] === true;
    }
  }
  localStorage.setItem(COUNTRY_STORAGE_KEY, JSON.stringify(countryData));
}

function toggleCountry(country, plug) {
  const data = loadCountryData();
  if (!data[country]) data[country] = {};
  data[country][plug] = !data[country][plug];
  saveCountryData(data);
  renderCountryGrid();
}

function renderCountryGrid() {
  const container = document.getElementById('countryGrid');
  const data = loadCountryData();
  let html = '<table class="country-table"><thead><tr><th>Country</th>';
  COUNTRY_PLUGS.forEach(p => html += `<th>${displayName(p)}</th>`);
  html += '</tr></thead><tbody>';
  COUNTRIES.forEach(country => {
    html += `<tr><td>${country}</td>`;
    COUNTRY_PLUGS.forEach(p => {
      const active = data[country]?.[p];
      html += `<td class="check-cell ${active?'active':'inactive'}" onclick="toggleCountry('${escHtml(country)}','${p}')">${active?'\u2705':'\u2796'}</td>`;
    });
    html += '</tr>';
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}

// ============================================================
// EMAIL CAMPAIGNS TAB
// ============================================================
const EMAIL_STORAGE_KEY = 'powerplugs-email-campaigns';

function loadEmails() { try { return JSON.parse(localStorage.getItem(EMAIL_STORAGE_KEY)) || []; } catch { return []; } }
function saveEmails(data) {
  localStorage.setItem(EMAIL_STORAGE_KEY, JSON.stringify(data));
  // Async save to Sheets
  saveEmailsToSheets(data);
}

async function saveEmailsToSheets(data) {
  if (!SheetsAPI.enabled) return;
  const headers = ['id','powerplug','name','sendDate','subject','recipients','opens','clicks','unsubscribes','notes'];
  const rows = data.map(item => headers.map(h => item[h] !== undefined ? item[h] : ''));
  await SheetsAPI.write('EmailCampaigns', rows, headers);
}

async function syncEmailsFromSheets() {
  const data = await SheetsAPI.read('EmailCampaigns');
  if (!data || data.length === 0) return;
  const emails = data.map(row => ({
    id: row.id || uuid(),
    powerplug: row.powerplug || 'General',
    name: row.name || '',
    sendDate: row.sendDate || '',
    subject: row.subject || '',
    recipients: Number(row.recipients) || 0,
    opens: Number(row.opens) || 0,
    clicks: Number(row.clicks) || 0,
    unsubscribes: Number(row.unsubscribes) || 0,
    notes: row.notes || '',
  }));
  localStorage.setItem(EMAIL_STORAGE_KEY, JSON.stringify(emails));
}

function addEmailCampaign() {
  const emails = loadEmails();
  emails.push({ id: uuid(), powerplug: currentPP === 'All' ? 'General' : currentPP, name: '', sendDate: '', subject: '', recipients: 0, opens: 0, clicks: 0, unsubscribes: 0, notes: '' });
  saveEmails(emails);
  renderEmailTracker();
}

function updateEmail(id, field, value) {
  const emails = loadEmails();
  const item = emails.find(e => e.id === id);
  if (item) {
    item[field] = ['recipients','opens','clicks','unsubscribes'].includes(field) ? Number(value)||0 : value;
    saveEmails(emails);
    renderEmailTracker();
  }
}

function deleteEmail(id) {
  let emails = loadEmails();
  emails = emails.filter(e => e.id !== id);
  saveEmails(emails);
  renderEmailTracker();
}

function importEmailCSV(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const text = e.target.result;
    const lines = text.split('\n').filter(l => l.trim());
    if (lines.length < 2) return;
    const headers = parseCSVLine(lines[0]).map(h => h.trim().toLowerCase());
    const emails = loadEmails();
    for (let i = 1; i < lines.length; i++) {
      const vals = parseCSVLine(lines[i]);
      const row = {};
      headers.forEach((h, idx) => row[h] = (vals[idx]||'').trim());
      emails.push({
        id: uuid(),
        powerplug: row.powerplug || row['powerplug type'] || 'General',
        name: row.name || row['campaign name'] || row.campaign || '',
        sendDate: row['send date'] || row.senddate || row.date || '',
        subject: row.subject || row['subject line'] || '',
        recipients: Number((row.recipients||'0').replace(/,/g,'')) || 0,
        opens: Number((row.opens||'0').replace(/,/g,'')) || 0,
        clicks: Number((row.clicks||'0').replace(/,/g,'')) || 0,
        unsubscribes: Number((row.unsubscribes||row.unsubs||'0').replace(/,/g,'')) || 0,
        notes: row.notes || '',
      });
    }
    saveEmails(emails);
    renderEmailTracker();
    input.value = '';
  };
  reader.readAsText(file);
}

function parseCSVLine(line) {
  const result = [];
  let current = '', inQuotes = false;
  for (let i = 0; i < line.length; i++) {
    const ch = line[i];
    if (inQuotes) {
      if (ch === '"') { if (line[i+1] === '"') { current += '"'; i++; } else { inQuotes = false; } }
      else { current += ch; }
    } else {
      if (ch === '"') { inQuotes = true; }
      else if (ch === ',') { result.push(current); current = ''; }
      else { current += ch; }
    }
  }
  result.push(current);
  return result;
}

function renderEmailTracker() {
  const container = document.getElementById('emailTracker');
  let emails = loadEmails();

  // Filter by PP if not All
  if (currentPP !== 'All') {
    emails = emails.filter(e => e.powerplug === currentPP || e.powerplug === 'General');
  }

  // Sort by send date descending
  emails.sort((a,b) => (b.sendDate||'').localeCompare(a.sendDate||''));

  if (!emails.length) {
    container.innerHTML = '<div class="no-campaigns">No email campaigns yet. Click "+ Add Email Campaign" to get started, or import a CSV.</div>';
    return;
  }

  let html = '<table class="email-table"><thead><tr><th>Powerplug</th><th>Campaign</th><th>Send Date</th><th>Subject Line</th><th>Recipients</th><th>Opens</th><th>Open Rate</th><th>Clicks</th><th>CTR</th><th>Unsubs</th><th>Notes</th><th></th></tr></thead><tbody>';
  emails.forEach(e => {
    const openRate = e.recipients > 0 ? ((e.opens / e.recipients) * 100).toFixed(1) + '%' : '\u2014';
    const ctr = e.opens > 0 ? ((e.clicks / e.opens) * 100).toFixed(1) + '%' : '\u2014';
    html += `<tr>
      <td><select onchange="updateEmail('${e.id}','powerplug',this.value)">${ppOptions(e.powerplug, true)}</select></td>
      <td><input type="text" value="${escHtml(e.name)}" onchange="updateEmail('${e.id}','name',this.value)" placeholder="Campaign name" /></td>
      <td><input type="date" value="${e.sendDate||''}" onchange="updateEmail('${e.id}','sendDate',this.value)" /></td>
      <td><input type="text" value="${escHtml(e.subject)}" onchange="updateEmail('${e.id}','subject',this.value)" placeholder="Subject line" /></td>
      <td><input type="number" value="${e.recipients||''}" onchange="updateEmail('${e.id}','recipients',this.value)" placeholder="0" style="width:80px" /></td>
      <td><input type="number" value="${e.opens||''}" onchange="updateEmail('${e.id}','opens',this.value)" placeholder="0" style="width:70px" /></td>
      <td class="calculated">${openRate}</td>
      <td><input type="number" value="${e.clicks||''}" onchange="updateEmail('${e.id}','clicks',this.value)" placeholder="0" style="width:70px" /></td>
      <td class="calculated">${ctr}</td>
      <td><input type="number" value="${e.unsubscribes||''}" onchange="updateEmail('${e.id}','unsubscribes',this.value)" placeholder="0" style="width:60px" /></td>
      <td><input type="text" value="${escHtml(e.notes||'')}" onchange="updateEmail('${e.id}','notes',this.value)" placeholder="Notes..." /></td>
      <td><button class="btn btn-danger" onclick="deleteEmail('${e.id}')">Del</button></td></tr>`;
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}

init();
</script>
</body>
</html>
